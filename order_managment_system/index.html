<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tyrone Agrochemicals - Order Management System</title>
  
  <!-- Firebase SDK v9+ (Modular) -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, writeBatch, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBowsklKCH-C5uVv1laoqE9joupuGeqVdk",
      authDomain: "tyrone-oms.firebaseapp.com",
      projectId: "tyrone-oms",
      storageBucket: "tyrone-oms.firebasestorage.app",
      messagingSenderId: "494239566320",
      appId: "1:494239566320:web:228c45fb1b67e80de9b535",
      measurementId: "G-1PCRE0LTWF"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Make Firebase services globally available
    window.firebase = {
      auth,
      db,
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      onSnapshot,
      writeBatch,
      setDoc,
      ready: true  // Mark Firebase as ready
    };
    
    console.log('‚úì Firebase initialized and ready');
    
    // Enable offline persistence
    enableIndexedDbPersistence(db)
      .catch((err) => {
        if (err.code === 'failed-precondition') {
          console.warn('Multiple tabs open, persistence disabled');
        } else if (err.code === 'unimplemented') {
          console.warn('Browser does not support persistence');
        }
      });
  </script>
  
  <style>
    /* Modern Login Page Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 25%, #4caf50 50%, #66bb6a 75%, #ffffff 100%);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
      overflow: hidden;
      position: relative;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .login-container::before {
      content: '';
      position: absolute;
      width: 500px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      top: -250px;
      right: -250px;
      animation: float 6s ease-in-out infinite;
    }

    .login-container::after {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      bottom: -150px;
      left: -150px;
      animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(20px); }
    }

    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 420px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      z-index: 10;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 2.5rem;
      animation: fadeInDown 0.8s ease;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-header .login-logo {
      max-width: 240px;
      height: auto;
      margin-bottom: 1.5rem;
      filter: drop-shadow(0 8px 12px rgba(0, 0, 0, 0.15));
      animation: scaleIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .login-header h1 {
      margin: 0 0 0.3rem 0;
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .login-header p {
      margin: 0;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      animation: fadeIn 0.8s ease 0.2s both;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .login-form > div {
      position: relative;
    }

    .login-form label {
      display: block;
      margin-bottom: 0.6rem;
      font-size: 0.9rem;
      font-weight: 700;
      color: #1e293b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .login-form input {
      width: 100%;
      padding: 0.95rem 1.2rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #f8fafc;
      font-weight: 500;
    }

    .login-form input::placeholder {
      color: #cbd5e1;
    }

    .login-form input:focus {
      outline: none;
      border-color: #2d8c3a;
      background: white;
      box-shadow: 0 0 0 4px rgba(45, 140, 58, 0.1), inset 0 0 0 1px rgba(45, 140, 58, 0.05);
      transform: translateY(-2px);
    }

    .login-form button {
      padding: 1rem;
      background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.8s ease 0.3s both;
    }

    .login-form button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .login-form button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(45, 140, 58, 0.4);
    }

    .login-form button:hover::before {
      width: 300px;
      height: 300px;
    }

    .login-form button:active {
      transform: translateY(-1px);
    }

    .login-error {
      background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
      color: #7f1d1d;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      font-size: 0.9rem;
      border: 2px solid #fecaca;
      display: none;
      animation: slideDown 0.3s ease;
      font-weight: 600;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .role-selector {
      margin-top: 2.5rem;
      padding-top: 2.5rem;
      border-top: 2px solid #e2e8f0;
      animation: fadeIn 0.8s ease 0.4s both;
    }

    .role-selector h3 {
      margin: 0 0 1.25rem 0;
      font-size: 0.8rem;
      color: #64748b;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .role-option {
      padding: 1rem 1.1rem;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.85rem;
      position: relative;
      overflow: hidden;
    }

    .role-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .role-option:hover::before {
      left: 100%;
    }

    .role-option:hover {
      border-color: #2d8c3a;
      background: linear-gradient(135deg, #f0fdf4 0%, #e8f5e9 100%);
      transform: translateX(5px);
      box-shadow: 0 8px 16px rgba(45, 140, 58, 0.15);
    }

    .role-option strong {
      display: block;
      margin-bottom: 0.3rem;
      color: #1e293b;
      font-weight: 700;
    }

    .role-option span {
      color: #64748b;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .hidden-page {
      display: none;
    }

    .header-user-info {
      position: absolute;
      right: 2rem;
      top: 2rem;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1.25rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      z-index: 1000;
      pointer-events: auto;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      z-index: 1001;
      pointer-events: auto;
      position: relative;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .logout-btn:active {
      transform: scale(0.95);
    }

    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --primary-light: #34d399;
      --secondary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --bg: #f0f9ff;
      --card: #ffffff;
      --border: #dbeafe;
      --text: #0f172a;
      --text-muted: #475569;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.03);
      --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
      --radius: 10px;
      --radius-lg: 16px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
      margin: 0;
      padding: 20px;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .app {
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 2.5rem 2rem;
      border-radius: var(--radius-lg);
      margin-bottom: 2rem;
      box-shadow: var(--shadow-xl);
      position: relative;
      border: none;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    }
    
    .header::after {
      content: '';
      position: absolute;
      bottom: -50px;
      left: -50px;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
    }
    
    .header-content {
      position: relative;
      z-index: 1;
    }
    
    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(to right, #ffffff, #e2e8f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .company-name {
      font-size: 1.1rem;
      opacity: 0.95;
      margin-bottom: 0.25rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .company-name::before {
      content: '';
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      opacity: 0.7;
    }
    
    .header-subtitle {
      opacity: 0.85;
      font-size: 0.95rem;
      font-weight: 400;
    }
    
    .system-status {
      position: absolute;
      right: 2rem;
      top: 2rem;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 2px solid var(--border);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 220px;
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-light);
    }
    
    .dashboard-card:hover::before {
      transform: scaleX(1);
    }
    
    .dashboard-card:nth-child(2)::before {
      background: linear-gradient(90deg, var(--secondary) 0%, #60a5fa 100%);
    }
    
    .dashboard-card:nth-child(3)::before {
      background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%);
    }
    
    .dashboard-card:nth-child(4)::before {
      background: linear-gradient(90deg, var(--info) 0%, #38bdf8 100%);
    }
    
    .dashboard-icon {
      font-size: 3.5rem;
      margin-bottom: 1.25rem;
      width: 90px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover .dashboard-icon {
      transform: scale(1.1);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
    }
    
    .dashboard-card:nth-child(2) .dashboard-icon {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);
      color: var(--secondary);
    }
    
    .dashboard-card:nth-child(2):hover .dashboard-icon {
      background: linear-gradient(135deg, var(--secondary) 0%, #60a5fa 100%);
      color: white;
    }
    
    .dashboard-card:nth-child(3) .dashboard-icon {
      background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
      color: var(--warning);
    }
    
    .dashboard-card:nth-child(3):hover .dashboard-icon {
      background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%);
      color: white;
    }
    
    .dashboard-card:nth-child(4) .dashboard-icon {
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(56, 189, 248, 0.1) 100%);
      color: var(--info);
    }
    
    .dashboard-card:nth-child(4):hover .dashboard-icon {
      background: linear-gradient(135deg, var(--info) 0%, #38bdf8 100%);
      color: white;
    }
    
    .dashboard-card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }
    
    .dashboard-card p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    /* Back to Dashboard Button */
    .back-to-dashboard {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .back-to-dashboard::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .back-to-dashboard:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .back-to-dashboard:hover::before {
      left: 100%;
    }
    
    /* Section Styles */
    .section {
      display: none;
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section.active {
      display: block;
    }
    
    /* Card Styles */
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 2px solid var(--border);
      margin-bottom: 1.5rem;
      transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }
    
    .card-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card-title::before {
      content: '';
      width: 8px;
      height: 24px;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 4px;
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 1.25rem;
      position: relative;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
      transition: color 0.3s ease;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
      font-family: 'Segoe UI', 'Inter', sans-serif;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
    }
    
    input[readonly] {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-color: #e2e8f0;
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.75rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 95, 35, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(26, 95, 35, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }
    
    .btn-outline:hover {
      background: #f8fafc;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    /* Badge Styles */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.875rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.025em;
    }
    
    .badge-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: var(--success);
      border: 1px solid #a7f3d0;
    }
    
    .badge-warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: var(--warning);
      border: 1px solid #fde68a;
    }
    
    .badge-danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    
    .badge-primary {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: var(--secondary);
      border: 1px solid #bfdbfe;
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      margin: 1.5rem 0;
      background: white;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px;
    }
    
    th {
      background: linear-gradient(135deg, #f0fdf4 0%, #e0f7ff 100%);
      padding: 1rem 1.25rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    
    td {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover td {
      background: #f0fdf4;
    }

    /* Formulation Table Specific Styling */
    #formulationTable tbody tr {
      transition: all 0.2s ease;
      background: white;
    }

    #formulationTable tbody tr:hover {
      background: linear-gradient(90deg, #f0fdf4 0%, #e0f7ff 100%);
      transform: scaleX(1.001);
      box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.1);
    }

    #formulationTable td strong {
      color: var(--primary);
      font-weight: 600;
    }

    #formulationTable .recordFormulation:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px -2px rgba(26, 95, 35, 0.3);
    }
    
    /* Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-dot.pending {
      background: var(--warning);
      box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2);
    }
    
    .status-dot.completed {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
    }
    
    /* Quick Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .stat-card:nth-child(1) {
      border-top: 4px solid var(--primary);
    }
    
    .stat-card:nth-child(2) {
      border-top: 4px solid var(--success);
    }
    
    .stat-card:nth-child(3) {
      border-top: 4px solid var(--warning);
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--text) 0%, var(--text-muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.3s ease;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.4s ease;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .modal-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      background: #f8fafc;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
      color: white;
      border-radius: 10px;
      box-shadow: var(--shadow-xl);
      z-index: 1001;
      transform: translateX(120%);
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    }
    
    .toast::before {
      content: '‚úì';
      font-size: 1.25rem;
      font-weight: bold;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%);
    }
    
    .toast.error::before {
      content: '‚úï';
    }
    
    .toast.warning {
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
    }
    
    .toast.warning::before {
      content: '‚ö†';
    }
    
    /* Calculation Display */
    .calculation-box {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .calculation-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e2e8f0;
      font-size: 1rem;
    }
    
    .calculation-row:last-child {
      border-bottom: none;
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    /* Hide/Show Classes */
    .hidden {
      display: none !important;
    }
    
    /* Formulation Item Checkbox */
    .formulation-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .formulation-item:hover {
      border-color: var(--primary);
      background: #f8fafc;
    }
    
    .formulation-item.selected {
      border-color: var(--success);
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    
    .formulation-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .formulation-item.selected .formulation-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .formulation-info {
      flex: 1;
    }
    
    .formulation-product {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    
    .formulation-quantity {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        margin: 1rem;
      }
    }
  </style>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
</head>
<body>
  <!-- Login Page -->
   

  <div id="loginPage" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <img src="./Tyrone Product Detail Page/logo.png" alt="Tyrone Logo" class="login-logo" width="300" height="100" position="center">
        <h1>Tyrone OMS</h1>
        <p>Order Management System</p>
      </div>
      
      <div id="loginError" class="login-error"></div>
      
      <form class="login-form" id="loginForm">
        <div>
          <label>üë§ Username</label>
          <input type="text" id="loginUsername" placeholder="Enter your username" autofocus>
        </div>
        <div>
          <label>üîê Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        <button type="submit">‚ú® Sign In</button>
      </form>
    </div>
  </div>

  <!-- Main Application Page -->
  <div id="appPage" class="hidden-page">
    <div class="app">
      <!-- Dashboard Section (Default) -->
      <div id="dashboardSection" class="section active">
        <!-- Header -->
        <div class="header">
          <div class="header-content">
            <h1>Order Management System</h1>
            <div class="company-name">Tyrone Agrochemicals Private Limited</div>
            <div class="header-subtitle">Professional Order Processing & Production Management</div>
          </div>
          <div class="system-status">
            <span class="status-dot"></span>
            <span>System Operational</span>
          </div>
          <div class="header-user-info">
            <span id="userRoleDisplay"></span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
          </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
          <div class="dashboard-card" id="masterDataCard">
            <div class="dashboard-icon">üë•</div>
            <h3>Master Data</h3>
            <p>Manage Customers & Products</p>
          </div>
          
          <div class="dashboard-card" id="createOrderCard">
            <div class="dashboard-icon">üìù</div>
            <h3>Create Order</h3>
            <p>New Box or Bulk Orders</p>
          </div>
          
          <div class="dashboard-card" id="ordersCard">
            <div class="dashboard-icon">üìã</div>
            <h3>Orders</h3>
            <p>View All Orders</p>
          </div>
          
          <div class="dashboard-card" id="formulationCard">
            <div class="dashboard-icon">‚öóÔ∏è</div>
            <h3>Formulation</h3>
            <p>Production View & Status</p>
          </div>
          
          <!-- ===== NEW: PACKING CARD ===== -->
          <div class="dashboard-card" id="packingCard">
            <div class="dashboard-icon">üì¶</div>
            <h3>Packing</h3>
            <p>Pack Finished Products</p>
          </div>
          
          <!-- ===== NEW: INVENTORY CARD ===== -->
          <div class="dashboard-card" id="inventoryCard">
            <div class="dashboard-icon">üìä</div>
            <h3>Inventory</h3>
            <p>Finished Goods Storage</p>
          </div>
          
          <div class="dashboard-card" id="dispatchCard">
            <div class="dashboard-icon">üöö</div>
            <h3>Dispatch</h3>
            <p>Logistics & Shipping</p>
          </div>
        </div>

      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="dashboardTotalCustomers">0</div>
          <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="dashboardTotalProducts">0</div>
          <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="dashboardPendingOrders">0</div>
          <div class="stat-label">Pending Orders</div>
        </div>
      </div>
    </div>

    <!-- Master Data Management Section -->
    <div id="masterDataSection" class="section">
      <button class="back-to-dashboard" onclick="showSection('dashboardSection')">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Master Data Management</h3>
          <div class="status-indicator">
            <span class="status-dot pending"></span>
            <span class="text-muted">Ready</span>
          </div>
        </div>
        
        <div class="form-row">
          <!-- Add Customer Form -->
          <div>
            <h4 style="margin-bottom: 1.5rem; color: var(--text); font-weight: 600;">Add Customer/Party</h4>
            <div class="form-group">
              <label>Company Name *</label>
              <input type="text" id="cust_company" placeholder="Enter company name">
            </div>
            <div class="form-group">
              <label>Contact Person *</label>
              <input type="text" id="cust_contact" placeholder="Contact person name">
            </div>
            <div class="form-group">
              <label>Phone Number *</label>
              <input type="tel" id="cust_phone" placeholder="Phone number">
            </div>
            <div class="form-group">
              <label>Address</label>
              <textarea id="cust_address" rows="3" placeholder="Full address"></textarea>
            </div>
            <button class="btn btn-primary" id="addCustomer">
              <span>‚ûï Add Customer</span>
            </button>
          </div>

          <!-- Add Product Form -->
          <div>
            <h4 style="margin-bottom: 1.5rem; color: var(--text); font-weight: 600;">Add Product</h4>
            <div class="form-group">
              <label>Party Name *</label>
              <select id="prod_party">
                <option value="">Select Party</option>
              </select>
            </div>
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="prod_name" placeholder="Enter product name">
            </div>
            <div class="form-group">
              <label>Technical Name (Chemical/Ingredient) *</label>
              <input type="text" id="prod_technical_name" placeholder="Enter technical name" style="font-weight: 600; color: #7c3aed;">
            </div>
            <div class="form-group">
              <label>Product Description</label>
              <textarea id="prod_desc" rows="3" placeholder="Product description"></textarea>
            </div>
            <button class="btn btn-success" id="addProduct">
              <span>üì¶ Add Product</span>
            </button>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid" style="margin-top: 2rem;">
          <div class="stat-card">
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">Total Customers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalParties">0</div>
            <div class="stat-label">Active Parties</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Order Section -->
    <div id="createOrderSection" class="section">
      <button class="back-to-dashboard" onclick="showSection('dashboardSection')">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Create New Order</h3>
          <span class="badge badge-warning">Draft</span>
        </div>
        
        <!-- Order Type Selection -->
        <div class="form-group">
          <label>Order Type *</label>
          <select id="order_type">
            <option value="box">Box Order</option>
            <option value="bulk">Bulk Order</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Order Number *</label>
            <input type="text" id="order_number" readonly>
          </div>
          <div class="form-group">
            <label>Order Date *</label>
            <input type="text" id="order_date" readonly>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Customer *</label>
            <select id="order_customer">
              <option value="">Select Customer</option>
            </select>
          </div>
          <div class="form-group">
            <label>Expected Delivery</label>
            <input type="date" id="order_delivery">
          </div>
        </div>
        
        <div class="form-group">
          <label>Special Instructions</label>
          <textarea id="order_notes" rows="3" placeholder="Any special instructions..."></textarea>
        </div>
        
        <!-- Box Order Fields -->
        <div id="boxOrderFields">
          <h4 style="margin: 2rem 0 1rem 0; color: var(--text); font-weight: 600;">Order Items (Box Order)</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Select Product (Brand)</label>
              <select id="line_product">
                <option value="">Select Customer First</option>
              </select>
            </div>
            <div class="form-group">
              <label>Technical Name (Auto-filled from Product Master)</label>
              <input type="text" id="line_technical_name" placeholder="Auto-filled" readonly style="font-weight: 600; color: #7c3aed; background-color: #f3f4f6; cursor: not-allowed;">
            </div>
            <div class="form-group">
              <label>Packing Size (Ltr/Kg)</label>
              <select id="line_packing_size">
                <option value="1">1 Ltr</option>
                <option value="0.5">500 ml</option>
                <option value="5">5 Ltr</option>
                <option value="10">10 Ltr</option>
                <option value="20">20 Ltr</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="form-group hidden" id="customPackingGroup">
              <label>Custom Packing Size (Ltr/Kg)</label>
              <input type="number" id="custom_packing_size" step="0.01" min="0.01" placeholder="Enter size">
            </div>
            <div class="form-group">
              <label>Pieces per Box</label>
              <select id="line_pieces_per_box">
                <option value="1">1 pcs/box</option>
                <option value="2">2 pcs/box</option>
                <option value="4">4 pcs/box</option>
                <option value="6">6 pcs/box</option>
                <option value="10">10 pcs/box</option>
                <option value="12">12 pcs/box</option>
                <option value="20">20 pcs/box</option>
                <option value="24">24 pcs/box</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="form-group hidden" id="customPiecesGroup">
              <label>Custom Pieces per Box</label>
              <input type="number" id="custom_pieces_per_box" min="1" placeholder="Enter pieces">
            </div>
            <div class="form-group">
              <label>Per Box Qty (Ltr/Kg)</label>
              <input type="text" id="perBoxQtyDisplay" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="0.00">
            </div>
            <div class="form-group">
              <label>Boxes Quantity</label>
              <input type="number" id="line_qty" min="1" value="1">
            </div>
            <div class="form-group" style="align-self: flex-end;">
              <button class="btn btn-primary" id="addLine">
                <span>+ Add Item</span>
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <table id="orderLinesTable">
              <thead>
                <tr>
                  <th>Brand Name</th>
                  <th>Technical Name</th>
                  <th>Packing Size</th>
                  <th>Pieces/Box</th>
                  <th>Per Box Qty</th>
                  <th>Boxes</th>
                  <th>Total Ltr/Kg</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <div class="calculation-box">
            <div class="calculation-row">
              <span>Total Boxes:</span>
              <span id="totalBoxes">0</span>
            </div>
            <div class="calculation-row">
              <span>Total Ltr/Kg:</span>
              <span id="totalLtrKg">0.00</span>
            </div>
          </div>
        </div>
        
        <!-- Bulk Order Fields -->
        <div id="bulkOrderFields" class="hidden">
          <h4 style="margin: 2rem 0 1rem 0; color: var(--text); font-weight: 600;">Order Item (Bulk Order)</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="bulk_product_name" placeholder="Enter product name">
            </div>
            <div class="form-group">
              <label>Quantity (Ltr/Kg) *</label>
              <input type="number" id="bulk_quantity" min="0.01" step="0.01" placeholder="Enter quantity">
            </div>
          </div>
          <div class="form-group">
            <label>Product Description</label>
            <textarea id="bulk_product_desc" rows="3" placeholder="Product description"></textarea>
          </div>
          <div class="form-group">
            <button class="btn btn-primary" id="addBulkItem">
              <span>+ Add Bulk Item</span>
            </button>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
          <div>
            <div class="text-muted">Order Type: <span id="orderTypeLabel" style="font-weight: 600; color: var(--text);">Box</span></div>
            <div style="font-size: 1.25rem; font-weight: 700;">Total Items: <span id="totalItems">0</span></div>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-outline" id="clearOrder">
              <span>üóëÔ∏è Clear Draft</span>
            </button>
            <button class="btn btn-primary" id="saveOrder">
              <span>üìÑ Create Order</span>
            </button>
          </div>
        </div>
      </div>
    </div>

<!-- Formulation Section -->
<div id="formulationSection" class="section">
  <button class="back-to-dashboard" onclick="showSection('dashboardSection')">
    ‚Üê Back to Dashboard
  </button>
  
  <div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h3 class="card-title" style="margin: 0;">‚öóÔ∏è Production - Formulation Tracking</h3>
        <span class="badge badge-primary">Real-time Production Status</span>
      </div>
      <button class="btn btn-outline" id="refreshFormulationBtn" style="height: fit-content; padding: 0.5rem 1rem; font-size: 0.9rem;">
        üîÑ Refresh
      </button>
    </div>
    
    <!-- Formulation Search & Filter -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
      <div class="form-group" style="margin-bottom: 0;">
        <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üîç Order Number</label>
        <input type="text" id="form_search_order" placeholder="e.g., BOX-0001" style="border: 2px solid transparent; transition: all 0.2s;">
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üë§ Customer Name</label>
        <input type="text" id="form_search_customer" placeholder="e.g., ABC Company" style="border: 2px solid transparent; transition: all 0.2s;">
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üì¶ Technical Name</label>
        <input type="text" id="form_search_technical" placeholder="e.g., Malathion 50% EC" style="border: 2px solid transparent; transition: all 0.2s;">
      </div>
    </div>
    
    <!-- Order List View (Default) -->
    <div id="orderListView" style="display: block;">
      <div class="table-container">
        <table id="formulationOrderTable">
          <thead>
            <tr>
              <th>Order Number</th>
              <th>Customer</th>
              <th>Order Type</th>
              <th>Order Date</th>
              <th>Total Qty</th>
              <th>Formulation Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Orders will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Order Detail View (Hidden by default) -->
    <div id="orderDetailView" style="display: none;">
      <button class="btn btn-outline" onclick="showOrderListView()" style="margin-bottom: 1.5rem; padding: 0.75rem 1.5rem;">
        ‚Üê Back to Orders
      </button>
      
      <div class="card" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
        <div class="card-header">
          <h3 class="card-title">
            <span id="detailOrderNumber"></span>
            <span class="badge badge-primary" id="detailOrderType" style="margin-left: 1rem;"></span>
          </h3>
          <div style="display: flex; gap: 1rem;">
            <span class="badge badge-success" id="detailCustomer"></span>
            <span class="badge badge-info" id="detailOrderDate"></span>
          </div>
        </div>
        
        <div class="table-container" style="margin-top: 1rem;">
          <table id="formulationDetailTable">
            <thead>
              <tr>
                <th>Product (Brand)</th>
                <th>Technical Name</th>
                <th>Packing Size</th>
                <th>Pieces/Box</th>
                <th>Ordered Boxes</th>
                <th>Total Ltr/Kg</th>
                <th>Formulated Qty</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Order details will be populated here -->
            </tbody>
          </table>
        </div>
        
        <!-- Technical Summary Section -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: white; border-radius: 12px; border: 2px solid #e2e8f0;">
          <h4 style="color: var(--text); font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            üìä Technical Summary
          </h4>
          <div id="technicalSummary">
            <!-- Technical summary will be populated here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Formulation Report Section -->
    <div style="margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid var(--border);">
      <h4 style="color: var(--text); font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
        üìä Production Reports & Analytics
      </h4>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Generate detailed reports to track production progress and performance metrics</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <button class="btn btn-outline" id="reportFormulationDate" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; transition: all 0.3s; border: 2px solid var(--border);">
          <span style="font-size: 1.2rem;">üìÖ</span> Date-wise Report
        </button>
        <button class="btn btn-outline" id="reportFormulationOrder" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; transition: all 0.3s; border: 2px solid var(--border);">
          <span style="font-size: 1.2rem;">üìã</span> Order-wise Report
        </button>
        <button class="btn btn-outline" id="reportFormulationProduct" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; transition: all 0.3s; border: 2px solid var(--border);">
          <span style="font-size: 1.2rem;">üì¶</span> Product-wise Report
        </button>
      </div>
    </div>
  </div>
</div>

    <!-- Orders Section -->
    <div id="ordersSection" class="section">
      <button class="back-to-dashboard" onclick="showSection('dashboardSection')">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">All Orders</h3>
          <span class="badge badge-primary">View Only</span>
        </div>
        
        <!-- Orders Filters -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="form-group" style="margin-bottom: 0;">
            <label>Search Order Number</label>
            <input type="text" id="orders_search" placeholder="Search order...">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label>Filter Status</label>
            <select id="orders_filter_status">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>
        
        <div class="table-container">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Order Number</th>
                <th>Order Date</th>
                <th>Customer Name</th>
                <th>Order Type</th>
                <th>Total Quantity</th>
                <th>Order Status</th>
                <th>Formulation Status</th>
                <th>Dispatch Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Dispatch Section -->
    <div id="dispatchSection" class="section">
      <button class="back-to-dashboard" onclick="showSection('dashboardSection')">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 class="card-title" style="margin: 0;">üì¶ Dispatch Management</h3>
            <span class="badge badge-primary">Order Fulfillment</span>
          </div>
          <button class="btn btn-outline" id="showAllOrdersBtn" style="padding: 0.5rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
            üìã Show All Orders
          </button>
        </div>

        <!-- Filter Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üìä Filter Orders</label>
            <select id="filter_status" style="border: 2px solid transparent; transition: all 0.2s; cursor: pointer;">
              <option value="pending">‚è≥ Pending Orders</option>
              <option value="completed">‚úÖ Completed Orders</option>
              <option value="all">üìã All Orders</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üîç Search Orders</label>
            <input type="text" id="filter_text" placeholder="Search by order number or customer..." 
                   style="border: 2px solid transparent; transition: all 0.2s;">
          </div>
        </div>
        
        <div id="ordersContainer" style="max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
          <!-- Orders will be loaded here -->
        </div>
        
        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <button class="btn btn-outline" id="refreshOrders" style="padding: 0.75rem 1.5rem;">
            <span>üîÑ Refresh Orders</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Force Complete Modal -->
    <div id="forceCompleteModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Force Complete Order</h3>
          <button class="btn btn-icon" id="closeModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 1.5rem;">This order still has <span id="remainingBoxesCount" style="font-weight: 700; color: var(--danger);">0</span> remaining.</p>
          <div class="form-group">
            <label>Completion Reason</label>
            <select id="completeReason">
              <option value="customer_cancelled">Customer Cancelled</option>
              <option value="stock_unavailable">Stock Unavailable</option>
              <option value="delivery_issues">Delivery Issues</option>
              <option value="quality_issues">Quality Issues</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Additional Notes</label>
            <textarea id="completeNotes" rows="3" placeholder="Provide details for forced completion..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancelComplete">Cancel</button>
          <button class="btn btn-danger" id="confirmForceComplete">Force Complete</button>
        </div>
      </div>
    </div>

    <!-- Dispatch Modal -->
    <div id="dispatchModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 class="modal-title">Dispatch Order <span id="dispatchOrderNumber"></span></h3>
          <button class="btn btn-icon closeDispatchModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <div><strong>Customer:</strong> <span id="dispatchCustomer"></span></div>
            <div><strong>Order Date:</strong> <span id="dispatchOrderDate"></span></div>
          </div>
          
          <div class="table-container" style="margin-bottom: 1.5rem;">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Ordered</th>
                  <th>Dispatched</th>
                  <th>Remaining</th>
                  <th>Dispatch Now</th>
                </tr>
              </thead>
              <tbody id="dispatchLines">
                <!-- Dispatch lines will be populated here -->
              </tbody>
            </table>
          </div>
          
          <div class="form-group">
            <label>Dispatch Date</label>
            <input type="date" id="dispatchDate">
          </div>
          <div class="form-group">
            <label>LR Number (Optional)</label>
            <input type="text" id="lrNumber" placeholder="Enter LR number">
          </div>
          <div class="form-group">
            <label>Dispatch Notes</label>
            <textarea id="dispatchNotes" rows="3" placeholder="Any dispatch notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline closeDispatchModal">Cancel</button>
          <button class="btn btn-primary" id="saveDispatch">Save Dispatch</button>
        </div>
      </div>
    </div>

    <!-- ===== NEW: PACKING SECTION ===== -->
    <div id="packingSection" class="section">
      <button class="btn btn-outline" onclick="showSection('dashboardSection')" style="margin-bottom: 1.5rem;">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üì¶ Packing Management</h3>
          <span class="badge badge-primary">Pack Finished Products</span>
        </div>
        
        <!-- Packing Search & Filter -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üîç Search Order</label>
            <input type="text" id="packing_search_order" placeholder="e.g., BOX-0001" style="border: 2px solid transparent; transition: all 0.2s;">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-weight: 600; color: #475569; font-size: 0.9rem;">üë§ Search Customer</label>
            <input type="text" id="packing_search_customer" placeholder="e.g., ABC Company" style="border: 2px solid transparent; transition: all 0.2s;">
          </div>
        </div>
        
        <div class="table-container">
          <table id="packingTable">
            <thead>
              <tr>
                <th>Order Number</th>
                <th>Customer</th>
                <th>Order Type</th>
                <th>Formulation Status</th>
                <th>Produced Qty</th>
                <th>Packing Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Packing records will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== NEW: PACKING MODAL ===== -->
<div id="packingModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">üì¶ Pack Order <span id="packingOrderNumber"></span></h3>
      <button class="btn btn-icon closePackingModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Order Summary -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #16a34a;">
        <div><strong>üìã Order Type:</strong> <span id="packingOrderType"></span></div>
        <div><strong>üë§ Customer:</strong> <span id="packingCustomer"></span></div>
        <div><strong>‚öóÔ∏è Formulated Qty:</strong> <span id="packingFormulatedQty"></span></div>
        <div><strong>üìÖ Order Date:</strong> <span id="packingOrderDate"></span></div>
      </div>
      
      <!-- Packing Table (Like Dispatch) -->
      <div class="table-container" style="margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>PRODUCT</th>
              <th>ORDERED (Boxes)</th>
              <th>PACKED</th>
              <th>REMAINING</th>
              <th>PACK NOW</th>
              <th>EXTRA</th>
              <th>TOTAL PACKED</th>
            </tr>
          </thead>
          <tbody id="packingTableBody">
            <!-- Product rows will be populated here -->
          </tbody>
        </table>
      </div>
      
      <!-- Bulk Leftover Calculation (Auto) -->
      <div id="bulkLeftoverSection" style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-radius: 10px; border-left: 4px solid #0284c7;">
        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">üìä Bulk Leftover Calculation (Auto)</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
          <div style="padding: 0.5rem; background: white; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #64748b;">Total Formulated</div>
            <div style="font-weight: 700; color: #059669;" id="totalFormulatedDisplay">0.00 Ltr/Kg</div>
          </div>
          <div style="padding: 0.5rem; background: white; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #64748b;">Total Packed (Ltr/Kg)</div>
            <div style="font-weight: 700; color: #1d4ed8;" id="totalPackedLtrDisplay">0.00 Ltr/Kg</div>
          </div>
          <div style="padding: 0.5rem; background: white; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #64748b;">Bulk Leftover</div>
            <div style="font-weight: 700; color: #dc2626;" id="bulkLeftoverDisplay">0.00 Ltr/Kg</div>
          </div>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #0c4a6e;">
          <strong>Formula:</strong> Bulk Leftover = Formulated Qty - (‚àë Packed Boxes √ó Per Box Qty)
        </div>
      </div>
      
      <!-- Extra Boxes to Inventory (Auto) -->
      <div id="extraBoxesSection" style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 10px; border-left: 4px solid #f59e0b;">
        <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">üì¶ Extra Packed Boxes to Inventory (Auto)</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
          <div style="padding: 0.5rem; background: white; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #64748b;">Extra Boxes Total</div>
            <div style="font-weight: 700; color: #d97706;" id="extraBoxesDisplay">0 boxes</div>
          </div>
          <div style="padding: 0.5rem; background: white; border-radius: 6px;">
            <div style="font-size: 0.85rem; color: #64748b;">To Inventory (Ltr/Kg)</div>
            <div style="font-weight: 700; color: #d97706;" id="extraToInventoryDisplay">0.00 Ltr/Kg</div>
          </div>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #92400e;">
          <strong>Note:</strong> Boxes packed beyond ordered quantity will go to inventory automatically
        </div>
      </div>
      
      <!-- Packing Details -->
      <div class="form-row">
        <div class="form-group">
          <label>üìÖ Packing Date</label>
          <input type="date" id="packingDate">
        </div>
        <div class="form-group">
          <label>üë§ Packed By</label>
          <input type="text" id="packedBy" value="${APP.currentUser ? APP.currentUser.username : 'Unknown'}" readonly style="background: #f3f4f6;">
        </div>
      </div>
      
      <div class="form-group">
        <label>üìù Packing Notes (Optional)</label>
        <textarea id="packingNotes" placeholder="e.g., Special packaging used, quality check passed..." style="min-height: 80px;"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline closePackingModal">Cancel</button>
      <button class="btn btn-success" id="savePacking">‚úì Complete Packing</button>
    </div>
  </div>
</div>

    <!-- ===== NEW: INVENTORY SECTION ===== -->
    <div id="inventorySection" class="section">
      <button class="btn btn-outline" onclick="showSection('dashboardSection')" style="margin-bottom: 1.5rem;">
        ‚Üê Back to Dashboard
      </button>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìä Inventory Management</h3>
          <span class="badge badge-primary">Finished Goods Storage</span>
        </div>
        
        <!-- Inventory Tabs -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0;">
          <button class="btn btn-outline" id="inventoryTabBox" style="border-bottom: 3px solid #1a5f23; color: #1a5f23; padding: 0.75rem 1.5rem;">
            üì¶ Box Inventory
          </button>
          <button class="btn btn-outline" id="inventoryTabBulk" style="border: none; padding: 0.75rem 1.5rem;">
            üß¥ Bulk Inventory
          </button>
        </div>
        
        <!-- Box Inventory View -->
        <div id="boxInventoryView">
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #16a34a;">
            <strong>üìê Box to Ltr/Kg Conversion:</strong>
            <div style="font-size: 0.9rem; color: #166534; margin-top: 0.5rem;">
              Per Box Qty (Ltr/Kg) = Packing Size √ó Pieces per Box
Total Stock (Ltr/Kg) = Available Boxes √ó Per Box Qty
 √ó Pieces per Box<br>
              <span style="font-style: italic;">Example: 5 boxes √ó 10 Ltr = 50 Ltr/Kg</span>
            </div>
          </div>
          <div class="table-container">
            <table id="boxInventoryTable">
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Product</th>
                  <th>Packing Size</th>
                  <th>Available (Ltr/Kg)</th>
                  <th>Last Updated</th>
                </tr>
              </thead>
              <tbody>
                <!-- Box inventory will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Bulk Inventory View -->
        <div id="bulkInventoryView" style="display: none;">
          <div class="table-container">
            <table id="bulkInventoryTable">
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Product</th>
                  <th>Available Ltr/Kg</th>
                  <th>Last Updated</th>
                </tr>
              </thead>
              <tbody>
                <!-- Bulk inventory will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== NEW: INVENTORY DISPATCH MODAL ===== -->
    <div id="inventoryDispatchModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">üöö Dispatch from Inventory</h3>
          <button class="btn btn-icon closeInventoryDispatchModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #16a34a;">
            <div><strong>Customer:</strong> <span id="dispatchInventoryCustomer"></span></div>
            <div><strong>Product:</strong> <span id="dispatchInventoryProduct"></span></div>
            <div><strong>Available Qty:</strong> <span id="dispatchInventoryAvailable"></span></div>
            <div><strong>Inventory Type:</strong> <span id="dispatchInventoryType"></span></div>
          </div>
          
          <div class="form-group">
            <label>üë§ Dispatched By</label>
            <input type="text" id="dispatchInventoryBy" readonly style="background: #f3f4f6; color: #6b7280;">
          </div>
          
          <div class="form-group">
            <label>üìÖ Dispatch Date</label>
            <input type="date" id="dispatchInventoryDate">
          </div>
          
          <div class="form-group">
            <label>üì¶ Quantity to Dispatch <span style="color: #dc2626;">*</span></label>
            <input type="number" id="dispatchInventoryQty" min="0" step="0.01" placeholder="Enter quantity" style="border: 2px solid #fecaca;">
          </div>
          
          <div class="form-group">
            <label>üìù Description (Who/Where it's being dispatched to)</label>
            <textarea id="dispatchInventoryDescription" placeholder="e.g., Dispatched to XYZ Customer or ABC Warehouse, reference invoice #..." style="min-height: 80px;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline closeInventoryDispatchModal">Cancel</button>
          <button class="btn btn-success" id="saveInventoryDispatch">‚úì Complete Dispatch</button>
        </div>
      </div>
    </div>

    <!-- ===== NEW: USE STOCK IN ORDER MODAL ===== -->
    <div id="useStockInOrderModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">üì¶ Use Inventory Stock in Order</h3>
          <button class="btn btn-icon closeUseStockModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 10px; border-left: 4px solid #f59e0b;">
            <div><strong>üìä Current Inventory:</strong></div>
            <div id="useStockInventoryInfo" style="margin-top: 0.5rem; font-weight: 600;"></div>
          </div>
          
          <div class="form-group">
            <label>üìã Order Number <span style="color: #dc2626;">*</span></label>
            <input type="text" id="useStockOrderNumber" placeholder="Enter order number" style="border: 2px solid #fecaca;">
          </div>
          
          <div class="form-group">
            <label>üè∑Ô∏è Product <span style="color: #dc2626;">*</span></label>
            <select id="useStockProduct" style="border: 2px solid #fecaca;">
              <option value="">Select product from order...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>üì¶ Quantity to Use (Ltr/Kg) <span style="color: #dc2626;">*</span></label>
            <input type="number" id="useStockQty" min="0" step="0.01" placeholder="Enter quantity in Ltr/Kg" style="border: 2px solid #fecaca;">
            <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem; padding: 0.75rem; background: #f3f4f6; border-radius: 5px;">
              <strong>üìê Box Conversion Formula:</strong><br>
              For box inventory: Quantity = Number of Boxes √ó Pieces per Box
            </div>
          </div>
          
          <div id="useStockValidation" style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; display: none;">
            <strong style="color: #16a34a;">‚úì Valid:</strong> <span id="useStockValidationText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline closeUseStockModal">Cancel</button>
          <button class="btn btn-success" id="saveUseStock">‚úì Add to Order</button>
        </div>
      </div>
    </div>

    <!-- Formulation Complete Modal -->
    <div id="formulationCompleteModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 class="modal-title">Mark Formulation Complete</h3>
          <button class="btn btn-icon closeFormulationModal" style="padding: 0.5rem; border-radius: 8px;">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="formulationItemsList">
            <!-- Formulation items will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline closeFormulationModal">Cancel</button>
          <button class="btn btn-success" id="confirmFormulationComplete">Mark Selected Complete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    // ===== APPLICATION STATE & LOGIN =====
    const APP = {
      currentSection: 'dashboardSection',
      workingLines: [],
      currentOrderId: null,
      currentRemaining: 0,
      customers: JSON.parse(localStorage.getItem('tyrone_customers')) || [],
      products: JSON.parse(localStorage.getItem('tyrone_products')) || [],
      orders: JSON.parse(localStorage.getItem('tyrone_orders')) || [],
      dispatches: JSON.parse(localStorage.getItem('tyrone_dispatches')) || [],
      formulations: JSON.parse(localStorage.getItem('tyrone_formulations')) || [],
      // ===== NEW: PACKING MANAGER DATA =====
      packingRecords: JSON.parse(localStorage.getItem('tyrone_packingRecords')) || [],
      boxInventory: JSON.parse(localStorage.getItem('tyrone_boxInventory')) || [],
      bulkInventory: JSON.parse(localStorage.getItem('tyrone_bulkInventory')) || [],
      inventoryDispatchRecords: JSON.parse(localStorage.getItem('tyrone_inventoryDispatchRecords')) || [],
      inventoryUsedInOrders: JSON.parse(localStorage.getItem('tyrone_inventoryUsedInOrders')) || [],
      nextBoxOrderNumber: 1,
      nextBulkOrderNumber: 1,
      selectedFormulationItems: new Set(),
      currentUser: null,  // { username, role, uid } when logged in
      isFirebaseUser: false  // Track if user is authenticated with Firebase
    };

    // ===== LOGIN SYSTEM =====
    const USERS = [
      { username: 'admin', password: 'admin123', role: 'Admin' },
      { username: 'formulation', password: 'form123', role: 'Formulation Manager' },
      { username: 'packing', password: 'pack123', role: 'Packing Manager' },
      { username: 'dispatch', password: 'disp123', role: 'Dispatch Manager' },
      { username: 'viewer', password: 'view123', role: 'Viewer' }
    ];

    function setDemoCredentials(roleType) {
      const user = USERS.find(u => {
        if (roleType === 'admin') return u.role === 'Admin';
        if (roleType === 'formulation') return u.role === 'Formulation Manager';
        if (roleType === 'packing') return u.role === 'Packing Manager';
        if (roleType === 'dispatch') return u.role === 'Dispatch Manager';
        if (roleType === 'viewer') return u.role === 'Viewer';
      });
      if (user) {
        document.getElementById('loginUsername').value = user.username;
        document.getElementById('loginPassword').value = user.password;
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      if (!username || !password) {
        errorDiv.textContent = 'Please enter username and password';
        errorDiv.style.display = 'block';
        return;
      }

      // First try local authentication
      const user = USERS.find(u => u.username === username && u.password === password);
      
      if (user) {
        console.log('User authenticated locally:', username);
        
        // Local user authentication successful
        APP.currentUser = { username: user.username, role: user.role, uid: 'local_' + user.username };
        APP.isFirebaseUser = false;
        
        // Save session to localStorage
        localStorage.setItem('tyrone_currentUser', JSON.stringify(APP.currentUser));
        
        // Try to also authenticate with Firebase for cloud sync
        tryFirebaseLogin(username, password).catch(err => {
          console.log('Firebase login optional, continuing...');
        });
        
        // Hide login page, show app
        document.getElementById('loginPage').classList.add('hidden-page');
        document.getElementById('appPage').classList.remove('hidden-page');
        
        // Initialize app (now async - loads from Firestore)
        try {
          console.log('Starting data initialization...');
          await initialize();
          console.log('‚úì Initialization complete');
        } catch (err) {
          console.error('Error during initialization:', err);
          showToast('Error loading data: ' + err.message, 'error');
        }
      } else {
        errorDiv.textContent = 'Invalid username or password';
        errorDiv.style.display = 'block';
        console.warn('Login failed: Invalid credentials');
      }
    }
    
    // Try to authenticate with Firebase for cloud backup
    async function tryFirebaseLogin(username, password) {
      if (!window.firebase || !window.firebase.auth) {
        return;
      }
      
      try {
        const email = `${username}@tyrone-oms.local`;
        const { signInWithEmailAndPassword } = window.firebase;
        const { user } = await signInWithEmailAndPassword(window.firebase.auth, email, password);
        
        APP.currentUser.uid = user.uid;
        APP.isFirebaseUser = true;
        console.log('‚úì Firebase authentication successful');
        
        // Load user's data from Firestore
        loadUserDataFromFirestore();
      } catch (error) {
        console.log('Firebase login skipped (create account first if needed)');
      }
    }
    
    // Load user's Firestore data
    async function loadUserDataFromFirestore() {
      if (!APP.currentUser?.uid || !APP.isFirebaseUser) return;
      
      try {
        console.log('Loading user data from Firestore...');
        const [customers, products, orders, dispatches, formulations, packingRecords, boxInventory, bulkInventory, inventoryDispatchRecords, inventoryUsedInOrders] = await Promise.all([
          loadFromFirestore('customers'),
          loadFromFirestore('products'),
          loadFromFirestore('orders'),
          loadFromFirestore('dispatches'),
          loadFromFirestore('formulations'),
          loadFromFirestore('packingRecords'),
          loadFromFirestore('boxInventory'),
          loadFromFirestore('bulkInventory'),
          loadFromFirestore('inventoryDispatchRecords'),
          loadFromFirestore('inventoryUsedInOrders')
        ]);
        
        // Merge Firestore data with local data (Firestore takes precedence)
        if (customers && customers.length > 0) APP.customers = customers;
        if (products && products.length > 0) APP.products = products;
        if (orders && orders.length > 0) APP.orders = orders;
        if (dispatches && dispatches.length > 0) APP.dispatches = dispatches;
        if (formulations && formulations.length > 0) APP.formulations = formulations;
        if (packingRecords && packingRecords.length > 0) APP.packingRecords = packingRecords;
        if (boxInventory && boxInventory.length > 0) APP.boxInventory = boxInventory;
        if (bulkInventory && bulkInventory.length > 0) APP.bulkInventory = bulkInventory;
        if (inventoryDispatchRecords && inventoryDispatchRecords.length > 0) APP.inventoryDispatchRecords = inventoryDispatchRecords;
        if (inventoryUsedInOrders && inventoryUsedInOrders.length > 0) APP.inventoryUsedInOrders = inventoryUsedInOrders;
        
        console.log('‚úì Firestore data merged successfully');
      } catch (error) {
        console.error('Error loading Firestore data:', error);
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('tyrone_currentUser');
        APP.currentUser = null;
        
        // Show login page, hide app
        document.getElementById('loginPage').classList.remove('hidden-page');
        document.getElementById('appPage').classList.add('hidden-page');
        
        // Reset form
        document.getElementById('loginForm').reset();
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('loginUsername').focus();
      }
    }

    function isAdmin() {
      return APP.currentUser && APP.currentUser.role === 'Admin';
    }

    function isFormulationManager() {
      return APP.currentUser && APP.currentUser.role === 'Formulation Manager';
    }

    // ===== NEW: PACKING MANAGER ROLE CHECK =====
    function isPackingManager() {
      return APP.currentUser && APP.currentUser.role === 'Packing Manager';
    }

    function isDispatchManager() {
      return APP.currentUser && APP.currentUser.role === 'Dispatch Manager';
    }

    function isViewer() {
      return APP.currentUser && APP.currentUser.role === 'Viewer';
    }

    function updateUserDisplay() {
      const roleEmoji = {
        'Admin': 'üë§',
        'Formulation Manager': '‚öóÔ∏è',
        'Packing Manager': 'üì¶',
        'Dispatch Manager': 'üöö',
        'Viewer': 'üëÅÔ∏è'
      };
      document.getElementById('userRoleDisplay').textContent = 
        `${roleEmoji[APP.currentUser.role]} ${APP.currentUser.username} (${APP.currentUser.role})`;
    }

    function restrictViewerFields() {
      if (isViewer()) {
        // Disable all inputs for viewer
        document.querySelectorAll('input, select, textarea').forEach(el => {
          el.disabled = true;
        });
        
        // Hide all action buttons for viewer
        document.querySelectorAll('.btn-primary, .btn-success, .btn-danger, .btn-outline').forEach(btn => {
          if (!btn.id.includes('logout') && !btn.classList.contains('back-to-dashboard')) {
            btn.style.display = 'none';
          }
        });
      }
    }

    function checkAccessibility(sectionId) {
      const role = APP.currentUser.role;
      const accessRules = {
        'dashboardSection': ['Admin', 'Formulation Manager', 'Packing Manager', 'Dispatch Manager', 'Viewer'],
        'masterDataSection': ['Admin'],
        'createOrderSection': ['Admin'],
        'ordersSection': ['Admin', 'Formulation Manager', 'Packing Manager', 'Dispatch Manager', 'Viewer'],
        'formulationSection': ['Admin', 'Formulation Manager'],
        'packingSection': ['Admin', 'Packing Manager'],
        'inventorySection': ['Admin', 'Packing Manager', 'Dispatch Manager', 'Formulation Manager'],
        'dispatchSection': ['Admin', 'Dispatch Manager']
      };

      if (!accessRules[sectionId] || !accessRules[sectionId].includes(role)) {
        showToast('You do not have access to this section', 'error');
        return false;
      }
      return true;
    }

    // ===== UTILITY FUNCTIONS =====
    
    /**
     * INVENTORY CALCULATION FUNCTION - MANDATORY FORMULA
     * Calculates total Ltr/Kg in inventory
     * Formula: totalLtrKg = availableBoxes √ó perBoxQty
     * 
     * CRITICAL RULES:
     * - This function MUST be called every time inventory Ltr/Kg is calculated
     * - Inventory must NEVER store pre-calculated Ltr/Kg from packing
     * - perBoxQty must come from order line, never recalculated in inventory
     * - Result is READ-ONLY in UI, never editable by user
     * 
     * @param {number} availableBoxes - Number of boxes in inventory (mutable)
     * @param {number} perBoxQty - Ltr/Kg per box from order (immutable, SINGLE SOURCE OF TRUTH)
     * @returns {number} - Total Ltr/Kg (calculated, not stored)
     */
    function calculateBoxInventoryTotalLtrKg(availableBoxes, perBoxQty) {
      const boxes = parseFloat(availableBoxes) || 0;
      const qty = parseFloat(perBoxQty) || 0;
      return boxes * qty;
    }
    
    function uid(prefix = 'id') {
      return prefix + Date.now().toString(36) + Math.floor(Math.random() * 9000 + 1000).toString(36);
    }

    // ===== FIREBASE INTEGRATION FUNCTIONS =====
    
    // Helper to save data to Firestore
    async function saveToFirestore(collectionName, data) {
      try {
        // Wait for Firebase to be ready
        const firebaseReady = await waitForFirebase(3000);
        if (!firebaseReady || !window.firebase || !window.firebase.db) {
          console.warn(`Firebase not ready, cannot save ${collectionName}`);
          return false;
        }
        
        const { doc, writeBatch, collection, getDocs } = window.firebase;
        const db = window.firebase.db;
        const userId = APP.currentUser?.uid || 'anonymous';
        
        console.log(`Saving ${collectionName} (${Array.isArray(data) ? data.length : 1} items) as user: ${userId}`);
        
        // Use batch write for better performance
        const batch = writeBatch(db);
        
        if (Array.isArray(data)) {
          // For arrays, save to collection path: /users/{userId}/{collectionName}/{docId}
          const colRef = collection(db, 'users', userId, collectionName);
          
          // Delete old documents first (to clean up)
          try {
            const querySnapshot = await getDocs(colRef);
            console.log(`Deleting ${querySnapshot.size} old ${collectionName} documents`);
            querySnapshot.forEach((doc) => {
              batch.delete(doc.ref);
            });
          } catch (e) {
            // Expected on first save - collection doesn't exist yet
            console.log(`New collection, creating: ${collectionName}`);
          }
          
          // Add new documents
          data.forEach((item) => {
            const itemId = item.id || Math.random().toString(36).substr(2, 9);
            const docRef = doc(db, 'users', userId, collectionName, itemId);
            batch.set(docRef, {
              ...item,
              id: itemId,
              updatedAt: new Date().toISOString()
            });
          });
        } else {
          // For single objects
          const docRef = doc(db, 'users', userId, collectionName, 'main');
          batch.set(docRef, {
            ...data,
            updatedAt: new Date().toISOString()
          });
        }
        
        await batch.commit();
        console.log(`‚úì Saved ${collectionName} (${Array.isArray(data) ? data.length : 1} items)`);
        return true;
      } catch (error) {
        console.error(`Firestore save error for ${collectionName}:`, error.code, error.message);
        showToast(`Error saving ${collectionName}: ${error.message}`, 'error');
        return false;
      }
    }
    
    // Wait for Firebase to be ready
    async function waitForFirebase(maxWait = 2000) {
      const startTime = Date.now();
      let checked = 0;
      while (!window.firebase || !window.firebase.ready) {
        checked++;
        if (Date.now() - startTime > maxWait) {
          console.warn(`Firebase not ready after ${maxWait}ms (checked ${checked} times)`);
          return false;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      console.log('‚úì Firebase is ready');
      return true;
    }
    
    // Helper to load data from Firestore
    async function loadFromFirestore(collectionName) {
      try {
        // Wait for Firebase to be ready
        const firebaseReady = await waitForFirebase();
        if (!firebaseReady || !window.firebase || !window.firebase.db) {
          console.warn(`Firebase not ready for ${collectionName}, returning empty array`);
          return [];
        }
        
        
        const { getDocs, collection } = window.firebase;
        const db = window.firebase.db;
        const userId = APP.currentUser?.uid || 'anonymous';
        
        const colRef = collection(db, 'users', userId, collectionName);
        const querySnapshot = await getDocs(colRef);
        
        const data = [];
        querySnapshot.forEach((doc) => {
          data.push(doc.data());
        });
        
        console.log(`‚úì Loaded ${collectionName} from Firestore: ${data.length} items`);
        return data;
      } catch (error) {
        console.warn(`Could not load ${collectionName}:`, error.message);
        return [];
      }
    }
    
    // Enhanced saveToStorage that syncs with Firestore
    async function saveToStorageWithFirebase() {
      // First save to localStorage (for offline support)
      localStorage.setItem('tyrone_customers', JSON.stringify(APP.customers));
      localStorage.setItem('tyrone_products', JSON.stringify(APP.products));
      localStorage.setItem('tyrone_orders', JSON.stringify(APP.orders));
      localStorage.setItem('tyrone_dispatches', JSON.stringify(APP.dispatches));
      localStorage.setItem('tyrone_formulations', JSON.stringify(APP.formulations));
      localStorage.setItem('tyrone_packingRecords', JSON.stringify(APP.packingRecords));
      localStorage.setItem('tyrone_boxInventory', JSON.stringify(APP.boxInventory));
      localStorage.setItem('tyrone_bulkInventory', JSON.stringify(APP.bulkInventory));
      localStorage.setItem('tyrone_inventoryDispatchRecords', JSON.stringify(APP.inventoryDispatchRecords));
      localStorage.setItem('tyrone_inventoryUsedInOrders', JSON.stringify(APP.inventoryUsedInOrders));
      
      // Then sync to Firestore if authenticated
      if (APP.currentUser && APP.currentUser.uid) {
        Promise.all([
          saveToFirestore('customers', APP.customers),
          saveToFirestore('products', APP.products),
          saveToFirestore('orders', APP.orders),
          saveToFirestore('dispatches', APP.dispatches),
          saveToFirestore('formulations', APP.formulations),
          saveToFirestore('packingRecords', APP.packingRecords),
          saveToFirestore('boxInventory', APP.boxInventory),
          saveToFirestore('bulkInventory', APP.bulkInventory),
          saveToFirestore('inventoryDispatchRecords', APP.inventoryDispatchRecords),
          saveToFirestore('inventoryUsedInOrders', APP.inventoryUsedInOrders)
        ]).catch(err => console.error('Firestore sync error:', err));
      }
    }

    // Async save function - use this for priority saves
    async function saveToStorageAsync() {
      // Save to Firestore only (NO localStorage)
      try {
        await Promise.all([
          saveToFirestore('customers', APP.customers),
          saveToFirestore('products', APP.products),
          saveToFirestore('orders', APP.orders),
          saveToFirestore('dispatches', APP.dispatches),
          saveToFirestore('formulations', APP.formulations),
          saveToFirestore('packingRecords', APP.packingRecords),
          saveToFirestore('boxInventory', APP.boxInventory),
          saveToFirestore('bulkInventory', APP.bulkInventory),
          saveToFirestore('inventoryDispatchRecords', APP.inventoryDispatchRecords),
          saveToFirestore('inventoryUsedInOrders', APP.inventoryUsedInOrders)
        ]);
        console.log('‚úì All data saved to Firestore');
        return true;
      } catch (err) {
        console.error('Error saving to Firestore:', err);
        showToast('Error saving data: ' + err.message, 'error');
        return false;
      }
    }

    // Non-async wrapper - save in background without waiting
    function saveToStorage() {
      // Save in background (don't wait for completion)
      saveToStorageAsync().catch(err => console.error('Background save failed:', err));
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function showSection(sectionId) {
      if (!checkAccessibility(sectionId)) {
        return;
      }

      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show requested section
      document.getElementById(sectionId).classList.add('active');
      APP.currentSection = sectionId;
      
      // Restrict viewer fields
      restrictViewerFields();
      
      // Load data for the section
      switch(sectionId) {
        case 'dashboardSection':
          updateDashboardStats();
          updateDashboardCards();
          break;
        case 'masterDataSection':
          renderMasterData();
          break;
        case 'createOrderSection':
          loadCreateOrderData();
          break;
        case 'ordersSection':
          renderOrdersTable();
          break;
        case 'formulationSection':
          renderFormulationTable();
          break;
        // ===== NEW: PACKING & INVENTORY SECTIONS =====
        case 'packingSection':
          renderPackingTable();
          break;
        case 'inventorySection':
          renderBoxInventory();
          renderBulkInventory();
          break;
        case 'dispatchSection':
          renderOrders();
          break;
      }
    }

    function updateDashboardCards() {
      const role = APP.currentUser.role;
      const grid = document.querySelector('.dashboard-grid');
      
      // Hide cards based on role
      document.getElementById('masterDataCard').style.display = isAdmin() ? 'flex' : 'none';
      document.getElementById('createOrderCard').style.display = isAdmin() ? 'flex' : 'none';
      document.getElementById('formulationCard').style.display = (isAdmin() || isFormulationManager()) ? 'flex' : 'none';
      // ===== NEW: PACKING & INVENTORY CARD VISIBILITY =====
      document.getElementById('packingCard').style.display = (isAdmin() || isPackingManager()) ? 'flex' : 'none';
      document.getElementById('inventoryCard').style.display = (isAdmin() || isPackingManager() || isDispatchManager()) ? 'flex' : 'none';
      document.getElementById('dispatchCard').style.display = (isAdmin() || isDispatchManager()) ? 'flex' : 'none';
    }

    // ===== DASHBOARD FUNCTIONS =====
    function updateDashboardStats() {
      const pendingOrders = APP.orders.filter(order => {
        const remaining = computeOrderRemaining(order, APP.dispatches);
        return remaining > 0;
      }).length;
      
      document.getElementById('dashboardTotalCustomers').textContent = APP.customers.length;
      document.getElementById('dashboardTotalProducts').textContent = APP.products.length;
      document.getElementById('dashboardPendingOrders').textContent = pendingOrders;
    }

    // ===== MASTER DATA MANAGEMENT =====
    function renderMasterData() {
      // Update counters
      document.getElementById('totalCustomers').textContent = APP.customers.length;
      document.getElementById('totalProducts').textContent = APP.products.length;
      
      // Count unique parties
      const parties = [...new Set(APP.products.map(p => p.party_id))];
      document.getElementById('totalParties').textContent = parties.length;
      
      // Fill party select for products
      const partySelect = document.getElementById('prod_party');
      partySelect.innerHTML = '<option value="">Select Party</option>' +
        APP.customers.map(c => `<option value="${c.id}">${c.company}</option>`).join('');
    }

    // Add Customer
    document.getElementById('addCustomer').addEventListener('click', () => {
      if (!isAdmin()) {
        showToast('Only Admin can add customers', 'error');
        return;
      }
      
      const company = document.getElementById('cust_company').value.trim();
      const contact = document.getElementById('cust_contact').value.trim();
      const phone = document.getElementById('cust_phone').value.trim();
      
      if (!company || !contact || !phone) {
        showToast('Company name, contact person and phone are required', 'error');
        return;
      }
      
      const newCustomer = {
        id: uid('CUST'),
        company,
        contact,
        phone,
        address: document.getElementById('cust_address').value.trim(),
        created_at: new Date().toISOString(),
        status: 'active'
      };
      
      APP.customers.push(newCustomer);
      saveToStorage();
      
      // Clear form
      ['cust_company', 'cust_contact', 'cust_phone', 'cust_address'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      renderMasterData();
      updateDashboardStats();
      showToast('Customer added successfully');
    });

    // Add Product
    document.getElementById('addProduct').addEventListener('click', () => {
      if (!isAdmin()) {
        showToast('Only Admin can add products', 'error');
        return;
      }
      
      const partyId = document.getElementById('prod_party').value;
      const name = document.getElementById('prod_name').value.trim();
      const technicalName = document.getElementById('prod_technical_name').value.trim();
      
      if (!partyId || !name || !technicalName) {
        showToast('Party, product name, and technical name are required', 'error');
        return;
      }
      
      // STEP 1: Product Master Data includes Technical Name
      const newProduct = {
        id: uid('PROD'),
        party_id: partyId,
        name,
        technical_name: technicalName,  // MASTER DATA: Set once, never changed
        description: document.getElementById('prod_desc').value.trim(),
        created_at: new Date().toISOString(),
        status: 'active'
      };
      
      APP.products.push(newProduct);
      saveToStorage();
      
      // Clear form
      ['prod_name', 'prod_desc', 'prod_technical_name'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('prod_party').value = '';
      
      renderMasterData();
      updateDashboardStats();
      showToast('‚úì Product added with Technical Name: ' + technicalName);
    });

    // ===== CREATE ORDER FUNCTIONS =====
    function loadCreateOrderData() {
      // Set current date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('order_date').value = today;
      document.getElementById('order_delivery').value = today;
      document.getElementById('dispatchDate').value = today;
      
      // Clear working lines
      APP.workingLines = [];
      renderWorkingLines();
      
      // Fill customer selects
      const custSelect = document.getElementById('order_customer');
      custSelect.innerHTML = '<option value="">Select Customer</option>' +
        APP.customers.map(c => `<option value="${c.id}">${c.company} (${c.contact})</option>`).join('');
      
      // Generate order number
      generateOrderNumber();
      
      // Update dashboard stats
      updateDashboardStats();
    }

    function generateOrderNumber() {
      // Calculate next order numbers
      const boxOrders = APP.orders.filter(o => o.order_type === 'box');
      const bulkOrders = APP.orders.filter(o => o.order_type === 'bulk');
      
      const nextBox = boxOrders.length + 1;
      const nextBulk = bulkOrders.length + 1;
      
      APP.nextBoxOrderNumber = nextBox;
      APP.nextBulkOrderNumber = nextBulk;
      
      const orderType = document.getElementById('order_type').value;
      const orderNumber = orderType === 'box' 
        ? `BOX-${String(nextBox).padStart(4, '0')}`
        : `BULK-${String(nextBulk).padStart(4, '0')}`;
      
      document.getElementById('order_number').value = orderNumber;
      document.getElementById('orderTypeLabel').textContent = orderType === 'box' ? 'Box Order' : 'Bulk Order';
    }

    // Order Type Change Handler
    document.getElementById('order_type').addEventListener('change', function() {
      const orderType = this.value;
      
      // Generate new order number
      generateOrderNumber();
      
      // Show/hide appropriate fields
      if (orderType === 'box') {
        document.getElementById('boxOrderFields').classList.remove('hidden');
        document.getElementById('bulkOrderFields').classList.add('hidden');
        document.getElementById('orderTypeLabel').textContent = 'Box Order';
      } else {
        document.getElementById('boxOrderFields').classList.add('hidden');
        document.getElementById('bulkOrderFields').classList.remove('hidden');
        document.getElementById('orderTypeLabel').textContent = 'Bulk Order';
        
        // Clear working lines for bulk order
        APP.workingLines = [];
        renderWorkingLines();
      }
      
      // Clear technical name when switching order types
      if (document.getElementById('line_technical_name')) {
        document.getElementById('line_technical_name').value = '';
      }
    });

    // Packing Size Change Handler
    document.getElementById('line_packing_size').addEventListener('change', function() {
      const value = this.value;
      const customPackingGroup = document.getElementById('customPackingGroup');
      
      if (value === 'custom') {
        customPackingGroup.classList.remove('hidden');
      } else {
        customPackingGroup.classList.add('hidden');
      }
    });

    // Pieces per Box Change Handler
    document.getElementById('line_pieces_per_box').addEventListener('change', function() {
      const value = this.value;
      const customPiecesGroup = document.getElementById('customPiecesGroup');
      
      if (value === 'custom') {
        customPiecesGroup.classList.remove('hidden');
      } else {
        customPiecesGroup.classList.add('hidden');
      }
    });

    // Customer Change Handler (for product filtering)
    document.getElementById('order_customer').addEventListener('change', function() {
      const customerId = this.value;
      const productSelect = document.getElementById('line_product');
      
      if (!customerId) {
        productSelect.innerHTML = '<option value="">Select Customer First</option>';
        document.getElementById('line_technical_name').value = '';
        return;
      }
      
      // Filter products by party_id matching customer id
      const customerProducts = APP.products.filter(p => p.party_id === customerId);
      
      if (customerProducts.length === 0) {
        productSelect.innerHTML = '<option value="">No products assigned to this customer</option>';
        showToast('Please assign products to this customer first', 'warning');
        document.getElementById('line_technical_name').value = '';
        return;
      }
      
      productSelect.innerHTML = '<option value="">Select Product</option>' +
        customerProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    });

    // STEP 2: Auto-fill Technical Name when product is selected from Product Master
    document.getElementById('line_product').addEventListener('change', function() {
      const productId = this.value;
      const technicalNameField = document.getElementById('line_technical_name');
      
      if (!productId) {
        technicalNameField.value = '';
        return;
      }
      
      const product = APP.products.find(p => p.id === productId);
      if (product && product.technical_name) {
        technicalNameField.value = product.technical_name;
        console.log('Auto-filled technical name:', product.technical_name);
      } else {
        technicalNameField.value = '';
        console.warn('Product not found or has no technical name:', productId);
      }
    });

    // Add Box Item to Order
    document.getElementById('addLine').addEventListener('click', addBoxOrderItem);

    // Add Bulk Item to Order
    document.getElementById('addBulkItem').addEventListener('click', addBulkOrderItem);
    
    // Update Per Box Qty Display when packing size changes
    document.getElementById('line_packing_size').addEventListener('change', function() {
      if (this.value === 'custom') {
        document.getElementById('customPackingGroup').classList.remove('hidden');
        document.getElementById('custom_packing_size').addEventListener('input', updatePerBoxQtyDisplay);
      } else {
        document.getElementById('customPackingGroup').classList.add('hidden');
        updatePerBoxQtyDisplay();
      }
    });
    
    // Update Per Box Qty Display when pieces per box changes
    document.getElementById('line_pieces_per_box').addEventListener('change', function() {
      if (this.value === 'custom') {
        document.getElementById('customPiecesGroup').classList.remove('hidden');
        document.getElementById('custom_pieces_per_box').addEventListener('input', updatePerBoxQtyDisplay);
      } else {
        document.getElementById('customPiecesGroup').classList.add('hidden');
        updatePerBoxQtyDisplay();
      }
    });

    // Calculate and display Per Box Qty (Ltr/Kg) - Formula: packingSize √ó piecesPerBox
    // This updates LIVE whenever packing size or pieces per box changes
    function updatePerBoxQtyDisplay() {
      const packingSizeSelect = document.getElementById('line_packing_size');
      const packingSizeValue = packingSizeSelect.value;
      const piecesSelect = document.getElementById('line_pieces_per_box');
      const piecesValue = piecesSelect.value;
      
      let packingSize, piecesPerBox;
      
      if (packingSizeValue === 'custom') {
        packingSize = parseFloat(document.getElementById('custom_packing_size').value) || 0;
      } else {
        packingSize = packingSizeValue === '' ? 0 : parseFloat(packingSizeValue);
      }
      
      if (piecesValue === 'custom') {
        piecesPerBox = parseInt(document.getElementById('custom_pieces_per_box').value) || 0;
      } else {
        piecesPerBox = piecesValue === '' ? 0 : parseInt(piecesValue);
      }
      
      // MANDATORY FORMULA: perBoxQty = packingSize √ó piecesPerBox
      const perBoxQty = packingSize * piecesPerBox;
      document.getElementById('perBoxQtyDisplay').value = perBoxQty.toFixed(2);
    }

    function addBoxOrderItem() {
      const productId = document.getElementById('line_product').value;
      const technicalName = document.getElementById('line_technical_name').value.trim();
      const packingSizeSelect = document.getElementById('line_packing_size');
      const packingSizeValue = packingSizeSelect.value;
      const piecesSelect = document.getElementById('line_pieces_per_box');
      const piecesValue = piecesSelect.value;
      const boxes = parseInt(document.getElementById('line_qty').value);
      
      if (!productId) {
        showToast('Please select a product from the customer list', 'error');
        return;
      }
      
      // STEP 2: Technical Name is auto-filled from Product Master (readonly)
      // Must be present since product was selected
      if (!technicalName) {
        showToast('Please select a product with a valid technical name in Product Master', 'error');
        return;
      }
      
      if (!boxes || boxes <= 0) {
        showToast('Please enter a valid box quantity', 'error');
        return;
      }
      
      let packingSize, piecesPerBox;
      
      if (packingSizeValue === 'custom') {
        packingSize = parseFloat(document.getElementById('custom_packing_size').value);
        if (!packingSize || packingSize <= 0) {
          showToast('Please enter a valid custom packing size', 'error');
          return;
        }
      } else {
        packingSize = parseFloat(packingSizeValue);
      }
      
      if (piecesValue === 'custom') {
        piecesPerBox = parseInt(document.getElementById('custom_pieces_per_box').value);
        if (!piecesPerBox || piecesPerBox <= 0) {
          showToast('Please enter a valid custom pieces per box', 'error');
          return;
        }
      } else {
        piecesPerBox = parseInt(piecesValue);
      }
      
      const product = APP.products.find(p => p.id === productId);
      if (!product) {
        showToast('Product not found', 'error');
        return;
      }
      
      // Calculate total Ltr/Kg
      const totalLtrKg = boxes * piecesPerBox * packingSize;
      
      // Check if product already in order (with same technical name, packing, pieces)
      const existingIndex = APP.workingLines.findIndex(line => 
        line.product_id === productId && 
        line.technical_name === technicalName &&
        line.packing_size === packingSize && 
        line.pieces_per_box === piecesPerBox
      );
      
      if (existingIndex > -1) {
        // Calculate perBoxQty - must be same for matching product/technical/packing/pieces
        const perBoxQty = packingSize * piecesPerBox;
        
        APP.workingLines[existingIndex].boxes += boxes;
        APP.workingLines[existingIndex].total_ltr_kg += totalLtrKg;
        // Ensure perBoxQty is stored (should match existing)
        if (!APP.workingLines[existingIndex].perBoxQty) {
          APP.workingLines[existingIndex].perBoxQty = perBoxQty;
        }
      } else {
        // Calculate perBoxQty ONCE - this is the SINGLE SOURCE OF TRUTH for this order line
        const perBoxQty = packingSize * piecesPerBox;
        
        APP.workingLines.push({
          id: uid('L'),
          product_id: productId,
          product_name: product.name,
          technical_name: technicalName,        // FROM MASTER: Technical name (IMMUTABLE, auto-filled)
          packing_size: packingSize,
          pieces_per_box: piecesPerBox,
          perBoxQty: perBoxQty,              // STORED: Ltr/Kg per box (packingSize √ó piecesPerBox)
          boxes: boxes,
          total_ltr_kg: totalLtrKg,
          added_at: new Date().toISOString(),
          order_type: 'box'
        });
      }
      
      renderWorkingLines();
      document.getElementById('line_qty').value = '1';
      showToast('Item added to order');
    }

    function addBulkOrderItem() {
      const productName = document.getElementById('bulk_product_name').value.trim();
      const quantity = parseFloat(document.getElementById('bulk_quantity').value);
      const description = document.getElementById('bulk_product_desc').value.trim();
      
      if (!productName || !quantity || quantity <= 0) {
        showToast('Please enter product name and quantity', 'error');
        return;
      }
      
      // For bulk orders, we only allow one item
      APP.workingLines = [{
        id: uid('L'),
        product_name: productName,
        description: description,
        quantity_ltr_kg: quantity,
        added_at: new Date().toISOString(),
        order_type: 'bulk'
      }];
      
      renderWorkingLines();
      showToast('Bulk order item added');
    }

    function renderWorkingLines() {
      const tbody = document.querySelector('#orderLinesTable tbody');
      const orderType = document.getElementById('order_type').value;
      
      tbody.innerHTML = '';
      
      if (orderType === 'box') {
        // Render box order lines
        APP.workingLines.forEach((line, idx) => {
          const tr = document.createElement('tr');
          // Display perBoxQty from stored value - SINGLE SOURCE OF TRUTH
          const perBoxQty = line.perBoxQty || (line.packing_size * line.pieces_per_box);
          tr.innerHTML = `
            <td>${line.product_name}</td>
            <td>${line.technical_name || '-'}</td>
            <td>${line.packing_size} Ltr/Kg</td>
            <td>${line.pieces_per_box}</td>
            <td><strong>${perBoxQty.toFixed(2)}</strong> Ltr/Kg</td>
            <td>${line.boxes}</td>
            <td>${line.total_ltr_kg.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger btn-sm removeLine" data-idx="${idx}" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                Remove
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        // Update totals
        let totalBoxes = 0;
        let totalLtrKg = 0;
        
        APP.workingLines.forEach(line => {
          totalBoxes += line.boxes;
          totalLtrKg += line.total_ltr_kg;
        });
        
        document.getElementById('totalItems').textContent = APP.workingLines.length;
        document.getElementById('totalBoxes').textContent = totalBoxes;
        document.getElementById('totalLtrKg').textContent = totalLtrKg.toFixed(2);
        
      } else {
        // Render bulk order line
        if (APP.workingLines.length > 0) {
          const line = APP.workingLines[0];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${line.product_name}</td>
            <td colspan="3">Bulk Order</td>
            <td>${line.quantity_ltr_kg.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger btn-sm removeLine" data-idx="0" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                Remove
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        }
        
        const totalLtrKg = APP.workingLines.length > 0 ? APP.workingLines[0].quantity_ltr_kg : 0;
        document.getElementById('totalItems').textContent = APP.workingLines.length;
        document.getElementById('totalBoxes').textContent = 'N/A';
        document.getElementById('totalLtrKg').textContent = totalLtrKg.toFixed(2);
      }
      
      // Bind remove buttons
      document.querySelectorAll('.removeLine').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.target.dataset.idx);
          APP.workingLines.splice(idx, 1);
          renderWorkingLines();
        });
      });
    }

    // Clear Order
    document.getElementById('clearOrder').addEventListener('click', () => {
      if (APP.workingLines.length > 0 && !confirm('Clear all items from this order?')) return;
      APP.workingLines = [];
      renderWorkingLines();
      document.getElementById('order_notes').value = '';
      document.getElementById('order_customer').value = '';
      document.getElementById('order_delivery').value = new Date().toISOString().split('T')[0];
      document.getElementById('line_product').innerHTML = '<option value="">Select Customer First</option>';
      
      // Clear bulk order fields
      document.getElementById('bulk_product_name').value = '';
      document.getElementById('bulk_quantity').value = '';
      document.getElementById('bulk_product_desc').value = '';
      
      // Clear custom fields
      document.getElementById('custom_packing_size').value = '';
      document.getElementById('custom_pieces_per_box').value = '';
      
      showToast('Order draft cleared');
    });

    // Save Order - FIXED VERSION
    document.getElementById('saveOrder').addEventListener('click', () => {
      const orderType = document.getElementById('order_type').value;
      const orderNumber = document.getElementById('order_number').value;
      const orderDate = document.getElementById('order_date').value;
      const customerId = document.getElementById('order_customer').value;
      
      // Validation check 1: Required fields
      if (!customerId) {
        showToast('Please select a customer first', 'error');
        return;
      }
      
      if (!orderNumber || !orderDate) {
        showToast('Order number and date should be auto-generated. Please refresh the page.', 'error');
        return;
      }
      
      console.log('Saving order with type:', orderType);
      console.log('Working lines:', APP.workingLines);
      console.log('Current orders count:', APP.orders.length);
      
      // FIXED: Check for bulk orders separately
      if (orderType === 'bulk') {
        // For bulk orders, check if we have a bulk item
        const hasBulkItem = APP.workingLines.some(line => line.order_type === 'bulk');
        if (!hasBulkItem) {
          showToast('Please add a bulk order item first', 'error');
          return;
        }
      } else {
        // For box orders, check for regular items
        if (APP.workingLines.length === 0) {
          showToast('Add at least one item to the order', 'error');
          return;
        }
      }
      
      // Check if order number already exists
      if (APP.orders.find(o => o.order_number === orderNumber)) {
        showToast('Order number must be unique', 'error');
        return;
      }
      
      const customer = APP.customers.find(c => c.id === customerId);
      if (!customer) {
        showToast('Customer not found', 'error');
        return;
      }
      
      let newOrder;
      
      if (orderType === 'box') {
        // Calculate totals for box order
        let totalBoxes = 0;
        let totalLtrKg = 0;
        
        APP.workingLines.forEach(line => {
          totalBoxes += line.boxes;
          totalLtrKg += line.total_ltr_kg;
        });
        
        newOrder = {
          id: uid('ORD'),
          order_type: 'box',
          order_number: orderNumber,
          customer_id: customerId,
          customer_name: customer.company,
          order_date: orderDate,
          delivery_date: document.getElementById('order_delivery').value || orderDate,
          notes: document.getElementById('order_notes').value.trim(),
          status: 'pending',
          lines: JSON.parse(JSON.stringify(APP.workingLines)),
          created_at: new Date().toISOString(),
          total_boxes: totalBoxes,
          total_ltr_kg: totalLtrKg,
          formulation_status: 'pending',
          formulation_completed_at: null,
          completed_at: null,
          line_formulation_status: {}
        };
        
        // Initialize formulation status for each line
        newOrder.lines.forEach(line => {
          newOrder.line_formulation_status[line.id] = 'pending';
        });
      } else {
        // Bulk order - FIXED: Get the bulk item correctly
        const bulkItem = APP.workingLines.find(line => line.order_type === 'bulk');
        if (!bulkItem) {
          showToast('No bulk item found', 'error');
          return;
        }
        
        newOrder = {
          id: uid('ORD'),
          order_type: 'bulk',
          order_number: orderNumber,
          customer_id: customerId,
          customer_name: customer.company,
          order_date: orderDate,
          delivery_date: document.getElementById('order_delivery').value || orderDate,
          notes: document.getElementById('order_notes').value.trim(),
          status: 'pending',
          lines: [{
            id: bulkItem.id,
            product_name: bulkItem.product_name,
            description: bulkItem.description,
            quantity_ltr_kg: bulkItem.quantity_ltr_kg,
            order_type: 'bulk'
          }],
          created_at: new Date().toISOString(),
          total_boxes: 0,
          total_ltr_kg: bulkItem.quantity_ltr_kg,
          formulation_status: 'pending',
          formulation_completed_at: null,
          completed_at: null,
          line_formulation_status: {}
        };
        
        // Initialize formulation status for bulk order line
        newOrder.line_formulation_status[bulkItem.id] = 'pending';
      }
      
      console.log('New order to save:', newOrder);
      APP.orders.push(newOrder);
      saveToStorage();
      
      // Clear form
      APP.workingLines = [];
      renderWorkingLines();
      document.getElementById('order_notes').value = '';
      document.getElementById('order_delivery').value = new Date().toISOString().split('T')[0];
      document.getElementById('order_customer').value = '';
      document.getElementById('line_product').innerHTML = '<option value="">Select Customer First</option>';
      
      // Clear bulk order fields
      document.getElementById('bulk_product_name').value = '';
      document.getElementById('bulk_quantity').value = '';
      document.getElementById('bulk_product_desc').value = '';
      
      // Clear custom fields
      document.getElementById('custom_packing_size').value = '';
      document.getElementById('custom_pieces_per_box').value = '';
      
      // Generate new order number
      generateOrderNumber();
      
      showToast('Order saved successfully');
      updateDashboardStats();
    });

    // ===== NEW: PACKING MANAGER FUNCTIONS =====
    /**
     * Get packing status for an order
     * Returns: 'not_started', 'partial', 'completed'
     */
    function getPackingStatus(orderId) {
      const packingRecords = APP.packingRecords.filter(p => p.order_id === orderId);
      if (packingRecords.length === 0) return 'not_started';
      
      // If any packing record exists, status is at least partial
      const hasCompleted = packingRecords.some(p => p.is_completed === true);
      return hasCompleted ? 'completed' : 'partial';
    }

    /**
     * Get formulated quantity for an order
     * Sums up all produced quantities
     */
    function getFormulatedQty(orderId, orderType) {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return 0;
      
      let formulatedQty = 0;
      
      if (orderType === 'bulk') {
  // For bulk orders, get produced qty from technical_name
  if (order.lines && order.lines.length > 0) {
    const technicalName = order.lines[0].technical_name;
    const formulation = APP.formulations.find(f => f.technical_name === technicalName);
    formulatedQty = formulation ? formulation.produced_qty : 0;
  }
} else {
  // For box orders, get produced qty for each technical name ONCE
  const technicalNames = [...new Set(order.lines.map(line => line.technical_name))];
  formulatedQty = technicalNames.reduce((total, tech) => {
    const formulation = APP.formulations.find(f => f.technical_name === tech);
    return total + (formulation ? formulation.produced_qty : 0);
  }, 0);
}
      
      // Add inventory stock used in this order (converts to production qty)
      const inventoryUsed = APP.inventoryUsedInOrders
        .filter(u => u.order_id === orderId)
        .reduce((sum, u) => sum + (u.qty_used || 0), 0);
      
      return formulatedQty + inventoryUsed;
    }

    /**
     * Check if order is eligible for packing
     * Must have formulation status = completed or partial
     */
    function isOrderEligibleForPacking(orderId) {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return false;
      
      // Check if formulation exists for this order's technical names
      // FIX: Formulation is now stored by technical_name, not by order_id
      if (order.lines && order.lines.length > 0) {
        const technicalNames = [...new Set(order.lines.map(line => line.technical_name))];
        const hasFormulation = technicalNames.some(tech => 
          APP.formulations.some(f => f.technical_name === tech)
        );
        return hasFormulation;
      }
      
      return false;
    }

    /**
     * Record packing for an order
     * Updates inventory and marks order as packed
     */
   // After packing calculations, add this:
const technicalGroups = {};

// Group all lines by technical name


// Get produced quantity for each technical from formulation
Object.keys(technicalGroups).forEach(tech => {
    const formulation = APP.formulations.find(f => f.technical_name === tech);
    technicalGroups[tech].totalProduced = formulation ? formulation.produced_qty : 0;
});



// Calculate leftover for each technical
const bulkLeftovers = {};
Object.keys(technicalGroups).forEach(tech => {
    const leftover = Math.max(0, technicalGroups[tech].totalProduced - technicalGroups[tech].totalPackedLtrKg);
    if (leftover > 0) {
        bulkLeftovers[tech] = leftover;
        
        // Add to bulk inventory
        const existingBulk = APP.bulkInventory.find(b => 
            b.customer === order.customer_name && 
            b.technical_name === tech
        );
        
        if (existingBulk) {
            existingBulk.available_qty += leftover;
        } else {
            APP.bulkInventory.push({
                id: uid('bulkinv'),
                customer: order.customer_name,
                technical_name: tech,
                product: tech, // Use technical name as product name for bulk
                available_qty: leftover,
                last_updated: new Date().toISOString()
            });
        }
    }
});
    /**
     * Get available inventory for dispatch
     */
    function getAvailableInventory(customer, product, type) {
      if (type === 'box') {
        const boxItems = APP.boxInventory.filter(
          b => b.customer === customer && b.product === product
        );
        return boxItems.reduce((sum, b) => sum + (b.available_boxes || 0), 0);
      } else {
        const bulkItems = APP.bulkInventory.filter(
          b => b.customer === customer && b.product === product
        );
        return bulkItems.reduce((sum, b) => sum + (b.available_qty || 0), 0);
      }
    }

    /**
     * Deduct from inventory after dispatch
     */
    function deductFromInventory(customer, product, type, quantity) {
      let remaining = quantity;

      if (type === 'box') {
        const boxItems = APP.boxInventory.filter(
          b => b.customer === customer && b.product === product
        );
        boxItems.sort((a, b) => new Date(a.last_updated) - new Date(b.last_updated));

        for (let item of boxItems) {
          if (remaining <= 0) break;
          const deduct = Math.min(item.available_boxes, remaining);
          item.available_boxes -= deduct;
          remaining -= deduct;
          item.last_updated = new Date().toISOString();
        }
      } else {
        const bulkItems = APP.bulkInventory.filter(
          b => b.customer === customer && b.product === product
        );
        bulkItems.sort((a, b) => new Date(a.last_updated) - new Date(b.last_updated));

        for (let item of bulkItems) {
          if (remaining <= 0) break;
          const deduct = Math.min(item.available_qty, remaining);
          item.available_qty -= deduct;
          remaining -= deduct;
          item.last_updated = new Date().toISOString();
        }
      }

      if (remaining > 0) {
        showToast(`Warning: Only ${quantity - remaining} of ${quantity} units available`, 'warning');
        return false;
      }

      saveToStorage();
      return true;
    }

    // ===== FORMULATION SECTION =====
    function computeOrderRemaining(order, dispatches) {
      if (order.order_type === 'bulk') {
        // For bulk orders, we need to track differently
        const dispatched = dispatches
          .filter(d => d.order_id === order.id)
          .reduce((s, d) => s + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
        return Math.max(0, order.total_ltr_kg - dispatched);
      } else {
        // For box orders
        return order.lines.reduce((sum, line) => {
          const dispatched = dispatches
            .filter(d => d.order_id === order.id && (d.order_line_id === line.id || d.product_name === line.product_name))
            .reduce((s, d) => s + Number(d.dispatched_boxes || 0), 0);
          return sum + Math.max(0, Number(line.boxes) - dispatched);
        }, 0);
      }
    }

    // ===== FORMULATION SECTION =====
    function computeOrderRemaining(order, dispatches) {
      if (order.order_type === 'bulk') {
        const dispatched = dispatches
          .filter(d => d.order_id === order.id)
          .reduce((s, d) => s + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
        return Math.max(0, order.total_ltr_kg - dispatched);
      } else {
        return order.lines.reduce((sum, line) => {
          const dispatched = dispatches
            .filter(d => d.order_id === order.id && (d.order_line_id === line.id || d.product_name === line.product_name))
            .reduce((s, d) => s + Number(d.dispatched_boxes || 0), 0);
          return sum + Math.max(0, Number(line.boxes) - dispatched);
        }, 0);
      }
    }

    function getFormulationStatus(order, lineId) {
      // Check if any formulation exists for this line
      const lineFormulations = APP.formulations.filter(f => f.order_id === order.id && f.line_id === lineId);
      
      if (lineFormulations.length === 0) {
        return 'pending';
      }
      
      let totalRequired = 0;
      let totalProduced = 0;
      
      if (order.order_type === 'box') {
        const line = order.lines.find(l => l.id === lineId);
        totalRequired = line.total_ltr_kg;
      } else {
        const line = order.lines.find(l => l.id === lineId);
        totalRequired = line.quantity_ltr_kg;
      }
      
      totalProduced = lineFormulations.reduce((sum, f) => sum + f.produced_qty, 0);
      
      if (totalProduced === 0) return 'pending';
      if (totalProduced < totalRequired) return 'partial';
      return 'completed';
    }

      // Show order list view
function showOrderListView() {
  document.getElementById('orderListView').style.display = 'block';
  document.getElementById('orderDetailView').style.display = 'none';
  renderFormulationOrderTable();
}

// Show order detail view
function showOrderDetailView(orderId) {
  document.getElementById('orderListView').style.display = 'none';
  document.getElementById('orderDetailView').style.display = 'block';
  renderOrderDetail(orderId);
}

// Render orders table
function renderFormulationOrderTable() {
  const tbody = document.querySelector('#formulationOrderTable tbody');
  const searchOrder = document.getElementById('form_search_order').value.toLowerCase().trim();
  const searchCustomer = document.getElementById('form_search_customer').value.toLowerCase().trim();
  const searchTechnical = document.getElementById('form_search_technical').value.toLowerCase().trim();
  
  tbody.innerHTML = '';
  
  // Filter orders
  const filteredOrders = APP.orders.filter(order => {
    // Apply search filters
    if (searchOrder && !order.order_number.toLowerCase().includes(searchOrder)) return false;
    if (searchCustomer && !order.customer_name.toLowerCase().includes(searchCustomer)) return false;
    
    // Check technical name filter
    if (searchTechnical && order.lines) {
      const hasTechnical = order.lines.some(line => 
        line.technical_name && line.technical_name.toLowerCase().includes(searchTechnical)
      );
      if (!hasTechnical) return false;
    }
    
    return true;
  }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  
  if (filteredOrders.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center" style="padding: 3rem;">
          <div style="font-size: 1rem; color: var(--text-muted);">üì≠ No orders found</div>
        </td>
      </tr>
    `;
    return;
  }
  
  // Render orders
  filteredOrders.forEach(order => {
    // Calculate formulation status for this order
    let formulationStatus = 'pending';
    let formulatedQty = 0;
    let requiredQty = 0;
    
    if (order.order_type === 'box') {
      // Get technical names in this order
      const technicalNames = [...new Set(order.lines.map(line => line.technical_name))];
      
      // Calculate totals
      technicalNames.forEach(tech => {
        const formulation = APP.formulations.find(f => f.technical_name === tech);
        formulatedQty += formulation ? formulation.produced_qty : 0;
      });
      
      requiredQty = order.lines.reduce((sum, line) => sum + line.total_ltr_kg, 0);
    } else {
      // Bulk order
      const technicalName = order.lines[0]?.technical_name;
      const formulation = APP.formulations.find(f => f.technical_name === technicalName);
      formulatedQty = formulation ? formulation.produced_qty : 0;
      requiredQty = order.total_ltr_kg;
    }
    
    // Determine status
    if (formulatedQty === 0) {
      formulationStatus = 'pending';
    } else if (formulatedQty >= requiredQty) {
      formulationStatus = 'completed';
    } else {
      formulationStatus = 'partial';
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong style="color: #1a5f23;">${order.order_number}</strong></td>
      <td>${order.customer_name}</td>
      <td><span class="badge badge-primary">${order.order_type.toUpperCase()}</span></td>
      <td>${order.order_date}</td>
      <td>
        ${order.order_type === 'box' 
          ? `${order.total_boxes} boxes (${order.total_ltr_kg.toFixed(2)} Ltr/Kg)` 
          : `${order.total_ltr_kg.toFixed(2)} Ltr/Kg`}
      </td>
      <td>
        <span class="badge ${formulationStatus === 'completed' ? 'badge-success' : formulationStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
          ${formulationStatus === 'completed' ? '‚úÖ COMPLETED' : formulationStatus === 'partial' ? 'üü° PARTIAL' : '‚ö™ PENDING'}
        </span>
      </td>
      <td>
        <button class="btn btn-primary btn-sm view-order-detail" 
                data-order-id="${order.id}"
                style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
          üëÅÔ∏è View Details
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Bind view detail buttons
  document.querySelectorAll('.view-order-detail').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.closest('button').dataset.orderId;
      showOrderDetailView(orderId);
    });
  });
}

// Render order details with technical names
function renderOrderDetail(orderId) {
  const order = APP.orders.find(o => o.id === orderId);
  if (!order) return;
  
  // Update header
  document.getElementById('detailOrderNumber').textContent = order.order_number;
  document.getElementById('detailOrderType').textContent = order.order_type.toUpperCase();
  document.getElementById('detailCustomer').textContent = order.customer_name;
  document.getElementById('detailOrderDate').textContent = order.order_date;
  
  // Clear tables
  const detailTbody = document.querySelector('#formulationDetailTable tbody');
  detailTbody.innerHTML = '';
  document.getElementById('technicalSummary').innerHTML = '';
  
  if (order.order_type === 'box') {
    // Group lines by technical name for summary
    const technicalGroups = {};
    
    // Process each line
    order.lines.forEach(line => {
      const technicalName = line.technical_name || 'Unknown Technical';
      
      // Initialize technical group if not exists
      if (!technicalGroups[technicalName]) {
        technicalGroups[technicalName] = {
          totalRequired: 0,
          products: []
        };
      }
      
      // Add to technical group
      technicalGroups[technicalName].totalRequired += line.total_ltr_kg;
      technicalGroups[technicalName].products.push({
        name: line.product_name,
        required: line.total_ltr_kg
      });
      
      // Get formulation for this technical name
      const formulation = APP.formulations.find(f => f.technical_name === technicalName);
      const formulatedQty = formulation ? formulation.produced_qty : 0;
      
      // Calculate status for this line
      let lineStatus = 'pending';
      if (formulatedQty === 0) {
        lineStatus = 'pending';
      } else if (formulatedQty >= technicalGroups[technicalName].totalRequired) {
        lineStatus = 'completed';
      } else {
        lineStatus = 'partial';
      }
      
      // Add row to detail table
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${line.product_name}</strong></td>
        <td style="font-weight: 600; color: #7c3aed;">${technicalName}</td>
        <td>${line.packing_size} Ltr</td>
        <td>${line.pieces_per_box}</td>
        <td>${line.boxes}</td>
        <td><strong>${line.total_ltr_kg.toFixed(2)}</strong> Ltr/Kg</td>
        <td>
          ${formulatedQty > 0 ? `
            <div style="color: #059669; font-weight: 600;">${formulatedQty.toFixed(2)} Ltr/Kg</div>
          ` : '<span class="text-muted">Not formulated</span>'}
        </td>
        <td>
          <span class="badge ${lineStatus === 'completed' ? 'badge-success' : lineStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
            ${lineStatus === 'completed' ? '‚úÖ' : lineStatus === 'partial' ? 'üü°' : '‚ö™'} ${lineStatus.toUpperCase()}
          </span>
        </td>
        <td>
          ${isFormulationManager() || isAdmin() ? `
            <button class="btn btn-primary btn-sm record-formulation-line" 
                    data-order-id="${order.id}"
                    data-line-id="${line.id}"
                    data-technical-name="${technicalName}"
                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
              üìù Record
            </button>
          ` : '<span class="text-muted">View only</span>'}
        </td>
      `;
      detailTbody.appendChild(tr);
    });
    
    // Create technical summary
    let summaryHTML = '';
    Object.entries(technicalGroups).forEach(([technicalName, group]) => {
      const formulation = APP.formulations.find(f => f.technical_name === technicalName);
      const formulatedQty = formulation ? formulation.produced_qty : 0;
      const remaining = Math.max(0, group.totalRequired - formulatedQty);
      
      summaryHTML += `
        <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #1a5f23;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; color: #1e293b; margin-bottom: 0.5rem;">‚öóÔ∏è ${technicalName}</div>
              <div style="font-size: 0.9rem; color: #64748b;">
                Products: ${group.products.map(p => p.name).join(', ')}
              </div>
            </div>
            <div style="text-align: right;">
              <div><strong>Required:</strong> ${group.totalRequired.toFixed(2)} Ltr/Kg</div>
              <div><strong>Formulated:</strong> <span style="color: #059669; font-weight: 600;">${formulatedQty.toFixed(2)} Ltr/Kg</span></div>
              <div><strong>Remaining:</strong> <span style="color: ${remaining > 0 ? '#ef4444' : '#059669'}; font-weight: 600;">${remaining.toFixed(2)} Ltr/Kg</span></div>
            </div>
          </div>
          ${isFormulationManager() || isAdmin() ? `
            <div style="margin-top: 1rem; text-align: right;">
              <button class="btn btn-primary record-formulation-technical" 
                      data-technical-name="${technicalName}"
                      data-required-qty="${group.totalRequired}"
                      data-formulated-qty="${formulatedQty}"
                      style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                üìù Record Formulation for ${technicalName}
              </button>
            </div>
          ` : ''}
        </div>
      `;
    });
    
    document.getElementById('technicalSummary').innerHTML = summaryHTML;
    
  } else {
    // Bulk order
    const line = order.lines[0];
    const technicalName = line.technical_name || line.product_name;
    const formulation = APP.formulations.find(f => f.technical_name === technicalName);
    const formulatedQty = formulation ? formulation.produced_qty : 0;
    const remaining = Math.max(0, line.quantity_ltr_kg - formulatedQty);
    let status = 'pending';
    
    if (formulatedQty === 0) {
      status = 'pending';
    } else if (formulatedQty >= line.quantity_ltr_kg) {
      status = 'completed';
    } else {
      status = 'partial';
    }
    
    // Add row to detail table
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${line.product_name}</strong></td>
      <td style="font-weight: 600; color: #7c3aed;">${technicalName}</td>
      <td colspan="2">Bulk Order</td>
      <td>-</td>
      <td><strong>${line.quantity_ltr_kg.toFixed(2)}</strong> Ltr/Kg</td>
      <td>
        ${formulatedQty > 0 ? `
          <div style="color: #059669; font-weight: 600;">${formulatedQty.toFixed(2)} Ltr/Kg</div>
        ` : '<span class="text-muted">Not formulated</span>'}
      </td>
      <td>
        <span class="badge ${status === 'completed' ? 'badge-success' : status === 'partial' ? 'badge-warning' : 'badge-danger'}">
          ${status === 'completed' ? '‚úÖ' : status === 'partial' ? 'üü°' : '‚ö™'} ${status.toUpperCase()}
        </span>
      </td>
      <td>
        ${isFormulationManager() || isAdmin() ? `
          <button class="btn btn-primary btn-sm record-formulation-line" 
                  data-order-id="${order.id}"
                  data-line-id="${line.id}"
                  data-technical-name="${technicalName}"
                  style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
            üìù Record
          </button>
        ` : '<span class="text-muted">View only</span>'}
      </td>
    `;
    detailTbody.appendChild(tr);
    
    // Technical summary for bulk order
    const summaryHTML = `
      <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #1a5f23;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <div style="font-weight: 700; font-size: 1.1rem; color: #1e293b; margin-bottom: 0.5rem;">‚öóÔ∏è ${technicalName}</div>
            <div style="font-size: 0.9rem; color: #64748b;">
              Product: ${line.product_name}
            </div>
          </div>
          <div style="text-align: right;">
            <div><strong>Required:</strong> ${line.quantity_ltr_kg.toFixed(2)} Ltr/Kg</div>
            <div><strong>Formulated:</strong> <span style="color: #059669; font-weight: 600;">${formulatedQty.toFixed(2)} Ltr/Kg</span></div>
            <div><strong>Remaining:</strong> <span style="color: ${remaining > 0 ? '#ef4444' : '#059669'}; font-weight: 600;">${remaining.toFixed(2)} Ltr/Kg</span></div>
          </div>
        </div>
        ${isFormulationManager() || isAdmin() ? `
          <div style="margin-top: 1rem; text-align: right;">
            <button class="btn btn-primary record-formulation-technical" 
                    data-technical-name="${technicalName}"
                    data-required-qty="${line.quantity_ltr_kg}"
                    data-formulated-qty="${formulatedQty}"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              üìù Record Formulation for ${technicalName}
            </button>
          </div>
        ` : ''}
      </div>
    `;
    
    document.getElementById('technicalSummary').innerHTML = summaryHTML;
  }
  
  // Bind record buttons
  document.querySelectorAll('.record-formulation-line').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const orderId = e.target.dataset.orderId;
      const lineId = e.target.dataset.lineId;
      const technicalName = e.target.dataset.technicalName;
      showFormulationRecordModalTechnical(technicalName);
    });
  });
  
  document.querySelectorAll('.record-formulation-technical').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const technicalName = e.target.dataset.technicalName;
      showFormulationRecordModalTechnical(technicalName);
    });
  });
}

    // NEW: Show formulation recording modal for TECHNICAL NAME (group-wise)
    function showFormulationRecordModalTechnical(technicalName) {
      // Find all orders/lines with this technical name
      const technicalLines = [];
let totalRequired = 0;

APP.orders.forEach(order => {
  if (order.order_type === 'box' && order.lines) {
    order.lines.forEach(line => {
      if (line.technical_name === technicalName) {
        totalRequired += line.total_ltr_kg;
        
        technicalLines.push({
          order_id: order.id,
          order_number: order.order_number,
          line_id: line.id,
          product_name: line.product_name,
          packing_size: line.packing_size,
          required: line.total_ltr_kg,

          // REMOVED: produced field
        });
      }
    });
  }
});

// Get produced qty ONCE from technical-level formulation
const formulation = APP.formulations.find(f => f.technical_name === technicalName);
const totalProduced = formulation ? formulation.produced_qty : 0;
      
      const remaining = totalRequired - totalProduced;
      
      const modal = `
        <div class="modal active" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" id="formulationRecordModalTech">
          <div class="modal-content" style="max-width: 600px; background: white; border-radius: 16px; padding: 0; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);">
            <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
              <h3 class="modal-title" style="margin: 0; font-size: 1.25rem; font-weight: 700;">‚öóÔ∏è Record Formulation - ${technicalName}</h3>
              <button onclick="closeFormulationRecordModal()" style="border: none; background: transparent; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
              <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <p style="margin: 0.5rem 0;"><strong>Technical Name:</strong> ${technicalName}</p>
                <p style="margin: 0.5rem 0;"><strong>Total Required (All Brands):</strong> ${totalRequired.toFixed(2)} Ltr/Kg</p>
                <p style="margin: 0.5rem 0;"><strong>Already Produced:</strong> ${totalProduced.toFixed(2)} Ltr/Kg</p>
                <p style="margin: 0.5rem 0;"><strong>Remaining:</strong> <span style="color: ${remaining > 0 ? '#ef4444' : '#059669'}; font-weight: 600;">${remaining.toFixed(2)} Ltr/Kg</span></p>
                <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e2e8f0;">
                <p style="margin: 0.5rem 0; font-size: 0.9rem; font-weight: 600;">Brands & Packing:</p>
                ${technicalLines.map(tl => `<div style="margin-left: 1rem; font-size: 0.85rem; color: #666;">‚Ä¢ ${tl.product_name} (${tl.packing_size} Ltr) - Required: ${tl.required.toFixed(2)} Ltr/Kg</div>`).join('')}
              </div>
              <div class="form-group">
                <label>Total Produced Quantity (Ltr/Kg) *</label>
                <input type="number" id="formulationProducedQtyTech" min="0" step="0.01" max="${totalRequired}" placeholder="Enter total produced quantity" value="${remaining}">
              </div>
              <div class="form-group">
                <label>Production Date</label>
                <input type="date" id="formulationDateTech" value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea id="formulationNotesTech" rows="2" placeholder="Any notes..."></textarea>
              </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc;">
              <button onclick="closeFormulationRecordModal()" class="btn btn-secondary">Cancel</button>
              <button id="saveFormulationTech" type="button" class="btn btn-primary">Save Formulation</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modal);
      
      // Save handler for technical formulation
      document.getElementById('saveFormulationTech').addEventListener('click', () => {
        const producedQty = parseFloat(document.getElementById('formulationProducedQtyTech').value);
        const date = document.getElementById('formulationDateTech').value;
        const notes = document.getElementById('formulationNotesTech').value.trim();
        
        if (!producedQty || producedQty <= 0) {
          showToast('Please enter a valid produced quantity', 'error');
          return;
        }
        
        // FIX: Store producedQty ONLY ONCE at technical/formulation summary level
        // NOT per product. Multiple products under same technical share the produced qty.
        // Example: 720 Ltr produced for "Malathion" √ó 2 products = still 720 Ltr (not 1440)
        // Remove existing formulation for this technical name
        APP.formulations = APP.formulations.filter(
        f => f.technical_name !== technicalName
        );

        const formulationSummary = {
        id: uid('form'),
        technical_name: technicalName,
        required_qty: totalRequired,  // Store required for reference
        produced_qty: producedQty,    // STORED ONLY ONCE at technical level
        production_date: date,
        notes: notes,
        recorded_by: APP.currentUser.username,
        recorded_at: new Date().toISOString()
        // REMOVED: line_ids to prevent duplication
        };
        APP.formulations.push(formulationSummary);
        console.log('Saved formulation (ONCE per technical):', formulationSummary);
        
        saveToStorage();
        showToast('‚úì Formulation recorded: ' + technicalName + ' = ' + producedQty.toFixed(2) + ' Ltr/Kg');
        renderFormulationTable();
        closeFormulationRecordModal();
      });
    }

    function showFormulationRecordModal(orderId, lineId) {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return;

      const line = order.lines.find(l => l.id === lineId);
      const currentProduced = APP.formulations.filter(f => f.order_id === orderId && f.line_id === lineId).reduce((s, f) => s + f.produced_qty, 0);
      const required = order.order_type === 'box' ? line.total_ltr_kg : line.quantity_ltr_kg;
      const remaining = required - currentProduced;

      const modal = `
        <div class="modal active" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" id="formulationRecordModal">
          <div class="modal-content" style="max-width: 500px; background: white; border-radius: 16px; padding: 0; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);">
            <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
              <h3 class="modal-title" style="margin: 0; font-size: 1.25rem; font-weight: 700;">Record Formulation</h3>
              <button onclick="closeFormulationRecordModal()" style="border: none; background: transparent; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
              <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <p style="margin: 0.5rem 0;"><strong>Order:</strong> ${order.order_number}</p>
                <p style="margin: 0.5rem 0;"><strong>Product:</strong> ${line.product_name}</p>
                <p style="margin: 0.5rem 0;"><strong>Required:</strong> ${required.toFixed(2)} Ltr/Kg</p>
                <p style="margin: 0.5rem 0;"><strong>Already Produced:</strong> ${currentProduced.toFixed(2)} Ltr/Kg</p>
                <p style="margin: 0.5rem 0;"><strong>Remaining:</strong> ${remaining.toFixed(2)} Ltr/Kg</p>
              </div>
              <div class="form-group">
                <label>Produced Quantity (Ltr/Kg) *</label>
                <input type="number" id="formulationProducedQty" min="0" step="0.01" max="${remaining}" placeholder="Enter produced quantity" value="${remaining}">
              </div>
              <div class="form-group">
                <label>Production Date</label>
                <input type="date" id="formulationDate" value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea id="formulationNotes" rows="3" placeholder="Any notes..."></textarea>
              </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc;">
              <button class="btn btn-outline" onclick="closeFormulationRecordModal()" style="border: 2px solid #e2e8f0; background: transparent; color: #1e293b; padding: 0.75rem 1.5rem;">Cancel</button>
              <button class="btn btn-primary" onclick="saveFormulationRecord('${orderId}', '${lineId}')" style="background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 100%); color: white; padding: 0.75rem 1.5rem;">Save Record</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeFormulationRecordModal() {
      // Close both technical and standard formulation modals
      const modalTech = document.getElementById('formulationRecordModalTech');
      const modalStandard = document.getElementById('formulationRecordModal');
      
      if (modalTech) modalTech.remove();
      if (modalStandard) modalStandard.remove();
    }

    function saveFormulationRecord(orderId, lineId) {
      const producedQty = parseFloat(document.getElementById('formulationProducedQty').value);
      const date = document.getElementById('formulationDate').value;
      const notes = document.getElementById('formulationNotes').value.trim();

      if (!producedQty || producedQty <= 0) {
        showToast('Please enter a valid produced quantity', 'error');
        return;
      }

      const formulation = {
        id: uid('FORM'),
        order_id: orderId,
        line_id: lineId,
        produced_qty: producedQty,
        date: date,
        notes: notes,
        username: APP.currentUser.username,
        created_at: new Date().toISOString()
      };

      APP.formulations = APP.formulations.filter(
      f => f.technical_name !== formulation.technical_name
      );

      APP.formulations.push(formulation);
      saveToStorage();
      closeFormulationRecordModal();
      renderFormulationTable();
      showToast('Formulation recorded successfully');
    }



    // Formulation Refresh Button
    // Formulation Report Buttons
    function generateFormulationReport(type) {
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Formulation Report</title>
          <style>
            body { font-family: 'Inter', sans-serif; padding: 2rem; background: #f8fafc; }
            .header { text-align: center; margin-bottom: 2rem; }
            .company-header { background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem; }
            table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
            th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
            th { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.75rem; }
          </style>
        </head>
        <body>
          <div class="company-header">
            <h1 style="margin: 0;">Tyrone Agrochemicals Private Limited</h1>
            <h2 style="margin: 0.5rem 0 0 0; opacity: 0.9;">Formulation Report</h2>
          </div>
          <div class="header">
            <h1 style="margin: 0 0 0.5rem 0;">${type === 'date' ? 'Date-wise' : type === 'order' ? 'Order-wise' : 'Product-wise'} Report</h1>
            <p style="margin: 0; color: #64748b;">Generated: ${new Date().toLocaleString()}</p>
          </div>
          <table>
            <thead><tr>
              ${type === 'date' ? '<th>Date</th><th>Order Number</th><th>Product</th><th>Produced (Ltr/Kg)</th><th>User</th>' : 
                type === 'order' ? '<th>Order Number</th><th>Date</th><th>Product</th><th>Produced (Ltr/Kg)</th><th>User</th>' :
                '<th>Product</th><th>Order Number</th><th>Date</th><th>Produced (Ltr/Kg)</th><th>User</th>'}
            </tr></thead>
            <tbody>
      `;

      const formulations = [...APP.formulations].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      if (type === 'date') {
        formulations.forEach(f => {
          const order = APP.orders.find(o => o.id === f.order_id);
          const line = order.lines.find(l => l.id === f.line_id);
          html += `<tr><td>${f.date}</td><td>${order.order_number}</td><td>${line.product_name}</td><td>${f.produced_qty.toFixed(2)}</td><td>${f.username}</td></tr>`;
        });
      } else if (type === 'order') {
        const grouped = {};
        formulations.forEach(f => {
          const order = APP.orders.find(o => o.id === f.order_id);
          if (!grouped[order.order_number]) grouped[order.order_number] = [];
          grouped[order.order_number].push(f);
        });
        Object.entries(grouped).forEach(([orderNum, forms]) => {
          forms.forEach(f => {
            const order = APP.orders.find(o => o.order_number === orderNum);
            const line = order.lines.find(l => l.id === f.line_id);
            html += `<tr><td>${orderNum}</td><td>${f.date}</td><td>${line.product_name}</td><td>${f.produced_qty.toFixed(2)}</td><td>${f.username}</td></tr>`;
          });
        });
      } else {
        const grouped = {};
        formulations.forEach(f => {
          const order = APP.orders.find(o => o.id === f.order_id);
          const line = order.lines.find(l => l.id === f.line_id);
          if (!grouped[line.product_name]) grouped[line.product_name] = [];
          grouped[line.product_name].push(f);
        });
        Object.entries(grouped).forEach(([product, forms]) => {
          forms.forEach(f => {
            const order = APP.orders.find(o => o.id === f.order_id);
            html += `<tr><td>${product}</td><td>${order.order_number}</td><td>${f.date}</td><td>${f.produced_qty.toFixed(2)}</td><td>${f.username}</td></tr>`;
          });
        });
      }

      html += `</tbody></table></body></html>`;
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
    }

    // ===== ORDERS SECTION =====
    function renderOrdersTable() {
      const tbody = document.querySelector('#ordersTable tbody');
      const search = document.getElementById('orders_search').value.toLowerCase().trim();
      const filterStatus = document.getElementById('orders_filter_status').value;
      
      console.log('=== renderOrdersTable called ===');
      console.log('Search value:', search);
      console.log('Filter status:', filterStatus);
      console.log('Total orders in APP:', APP.orders.length);

      tbody.innerHTML = '';

      // First apply search filter
      let orders = APP.orders.filter(order => {
        if (search && !order.order_number.toLowerCase().includes(search) && !order.customer_name.toLowerCase().includes(search)) {
          return false;
        }
        return true;
      });
      
      console.log('Orders after search filter:', orders.length);

      // Then apply status filter
      orders = orders.filter(order => {
        if (filterStatus) {
          const remaining = computeOrderRemaining(order, APP.dispatches);
          const orderStatus = remaining === 0 ? 'completed' : 'pending';
          if (orderStatus !== filterStatus) return false;
        }
        return true;
      });
      
      console.log('Orders after status filter:', orders.length);

      orders = orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">üì≠ No orders found matching your criteria</td></tr>`;
        return;
      }

      orders.forEach(order => {
        const remaining = computeOrderRemaining(order, APP.dispatches);
        const orderStatus = remaining === 0 ? 'completed' : 'pending';

        const formulationStatus = order.lines.every(l => getFormulationStatus(order, l.id) === 'completed') ? 'completed' : 
                                  order.lines.some(l => getFormulationStatus(order, l.id) !== 'pending') ? 'partial' : 'pending';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.order_number}</td>
          <td>${order.order_date}</td>
          <td>${order.customer_name}</td>
          <td><span class="badge badge-primary">${order.order_type.toUpperCase()}</span></td>
          <td>${order.order_type === 'box' ? order.total_boxes + ' boxes' : order.total_ltr_kg.toFixed(2) + ' Ltr/Kg'}</td>
          <td><span class="badge ${orderStatus === 'completed' ? 'badge-success' : 'badge-warning'}">${orderStatus.toUpperCase()}</span></td>
          <td><span class="badge ${formulationStatus === 'completed' ? 'badge-success' : formulationStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">${formulationStatus.toUpperCase()}</span></td>
          <td><span class="badge ${remaining === 0 ? 'badge-success' : 'badge-warning'}">${remaining === 0 ? 'DISPATCHED' : 'PENDING'}</span></td>
          <td>
            ${isAdmin() ? `
              <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Delete</button>
            ` : ''}
            <button class="btn btn-outline btn-sm" onclick="showOrderDetail('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">View</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function deleteOrder(orderId) {
      if (!isAdmin()) {
        showToast('Only Admin can delete orders', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to delete this order?')) {
        APP.orders = APP.orders.filter(o => o.id !== orderId);
        saveToStorage();
        renderOrdersTable();
        showToast('Order deleted successfully');
      }
    }

    // ===== NEW: PACKING SECTION FUNCTIONS =====
    function renderPackingTable() {
      const tbody = document.querySelector('#packingTable tbody');
      const searchOrder = document.getElementById('packing_search_order').value.toLowerCase().trim();
      const searchCustomer = document.getElementById('packing_search_customer').value.toLowerCase().trim();
      
      console.log('=== renderPackingTable called ===');
      console.log('Search Order:', searchOrder);
      console.log('Search Customer:', searchCustomer);
      
      tbody.innerHTML = '';
      
      // Get orders eligible for packing (formulated, not yet packed)
      const eligibleOrders = APP.orders.filter(order => {
        // Must be formulated
        if (!isOrderEligibleForPacking(order.id)) return false;
        
        // Must not be already packed
        const packingStatus = getPackingStatus(order.id);
        if (packingStatus === 'completed') return false;
        
        // Apply search filters
        if (searchOrder && !order.order_number.toLowerCase().includes(searchOrder)) return false;
        if (searchCustomer && !order.customer_name.toLowerCase().includes(searchCustomer)) return false;
        
        return true;
      });
      
      console.log('Eligible orders for packing:', eligibleOrders.length);
      
      if (eligibleOrders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center" style="padding: 3rem;">
              <div style="font-size: 1rem; color: var(--text-muted);">üì≠ No orders available for packing</div>
            </td>
          </tr>
        `;
        return;
      }
      
      eligibleOrders.forEach(order => {
        // FIX: Check formulation status by technical_name, not order_id
        let formulationStatus = 'pending';
        if (order.lines && order.lines.length > 0) {
          const technicalNames = [...new Set(order.lines.map(line => line.technical_name))];
          formulationStatus = technicalNames.some(tech => 
            APP.formulations.some(f => f.technical_name === tech)
          ) ? 'completed' : 'pending';
        }
        
        const formulatedQty = getFormulatedQty(order.id, order.order_type);
        const packingStatus = getPackingStatus(order.id);
        
        const statusColors = {
          'not_started': '#fbbf24',
          'partial': '#60a5fa',
          'completed': '#10b981'
        };
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${order.order_number}</strong></td>
          <td>${order.customer_name}</td>
          <td><span class="badge badge-primary">${order.order_type.toUpperCase()}</span></td>
          <td><span class="badge badge-success">COMPLETED</span></td>
          <td>${formulatedQty.toFixed(2)} Ltr/Kg</td>
          <td><span class="badge" style="background-color: ${statusColors[packingStatus]}; color: white;">${packingStatus.toUpperCase().replace('_', ' ')}</span></td>
          <td>
            <button class="btn btn-success btn-sm" onclick="showPackingModal('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üì¶ Pack</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showPackingModal(orderId) {
  const order = APP.orders.find(o => o.id === orderId);
  if (!order) return;
  
  document.getElementById('packingOrderNumber').textContent = order.order_number;
  document.getElementById('packingOrderType').textContent = order.order_type.toUpperCase();
  document.getElementById('packingCustomer').textContent = order.customer_name;
  document.getElementById('packingOrderDate').textContent = order.order_date;
  
  // Get formulated quantity from technical-level formulation
  let totalFormulated = 0;
  const technicalNames = [...new Set(order.lines.map(line => line.technical_name))];
  technicalNames.forEach(tech => {
    const formulation = APP.formulations.find(f => f.technical_name === tech);
    totalFormulated += formulation ? formulation.produced_qty : 0;
  });
  
  document.getElementById('packingFormulatedQty').textContent = 
    totalFormulated.toFixed(2) + ' Ltr/Kg';
  document.getElementById('totalFormulatedDisplay').textContent = 
    totalFormulated.toFixed(2) + ' Ltr/Kg';
  
  // Set today's date
  document.getElementById('packingDate').valueAsDate = new Date();
  document.getElementById('packingNotes').value = '';
  
  // Store current order ID and formulated qty
  document.getElementById('packingModal').dataset.orderId = orderId;
  document.getElementById('packingModal').dataset.totalFormulated = totalFormulated;
  
  // Populate packing table (like Dispatch page)
  const tableBody = document.getElementById('packingTableBody');
  tableBody.innerHTML = '';
  
  if (order.order_type === 'box') {
    // Group by product + technical + packing size (unique combinations)
    const uniqueProducts = {};
    
    order.lines.forEach(line => {
      const key = `${line.product_name}_${line.technical_name}_${line.packing_size}_${line.pieces_per_box}`;
      if (!uniqueProducts[key]) {
        uniqueProducts[key] = {
          product_name: line.product_name,
          technical_name: line.technical_name,
          packing_size: line.packing_size,
          pieces_per_box: line.pieces_per_box,
          totalOrdered: 0,
          perBoxQty: line.perBoxQty || (line.packing_size * line.pieces_per_box)
        };
      }
      uniqueProducts[key].totalOrdered += line.boxes;
    });
    
    // Create rows for each unique product
    Object.values(uniqueProducts).forEach((product, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight: 600;">${product.product_name}</div>
          <div style="font-size: 0.85rem; color: #7c3aed;">‚öóÔ∏è ${product.technical_name}</div>
          <div style="font-size: 0.85rem; color: #64748b;">${product.packing_size} Ltr √ó ${product.pieces_per_box} pcs/box</div>
        </td>
        <td style="text-align: center; font-weight: 600;">${product.totalOrdered}</td>
        <td style="text-align: center; color: #059669; font-weight: 600;" id="packedCount_${index}">0</td>
        <td style="text-align: center; color: #dc2626; font-weight: 600;" id="remainingCount_${index}">${product.totalOrdered}</td>
        <td style="text-align: center;">
          <input type="number" 
                class="pack-now-input"
                data-index="${index}"
                data-perbox="${product.perBoxQty}"
                data-ordered="${product.totalOrdered}"
                min="0" 
                max="${product.totalOrdered * 2}"
                value="${product.totalOrdered}"
                style="width: 80px; padding: 0.5rem; text-align: center; border: 2px solid #1a5f23; border-radius: 6px; font-weight: 600;">
        </td>
        <td style="text-align: center; color: #d97706; font-weight: 600;" id="extraCount_${index}">0</td>
        <td style="text-align: center;">
          <div style="font-weight: 600;" id="totalLtr_${index}">${(product.totalOrdered * product.perBoxQty).toFixed(2)}</div>
          <div style="font-size: 0.75rem; color: #64748b;">Ltr/Kg</div>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  } else {
    // Bulk order
    const line = order.lines[0];
    const technicalName = line.technical_name || line.product_name;
    const formulation = APP.formulations.find(f => f.technical_name === technicalName);
    const formulatedQty = formulation ? formulation.produced_qty : 0;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="font-weight: 600;">${line.product_name}</div>
        <div style="font-size: 0.85rem; color: #7c3aed;">‚öóÔ∏è ${technicalName}</div>
      </td>
      <td style="text-align: center; font-weight: 600;">${order.total_ltr_kg.toFixed(2)} Ltr/Kg</td>
      <td style="text-align: center; color: #059669; font-weight: 600;" id="packedCount_0">0.00</td>
      <td style="text-align: center; color: #dc2626; font-weight: 600;" id="remainingCount_0">${order.total_ltr_kg.toFixed(2)}</td>
      <td style="text-align: center;">
        <input type="number" 
              class="pack-now-input"
              data-index="0"
              data-perbox="1"
              data-ordered="${order.total_ltr_kg}"
              data-isbulk="true"
              min="0" 
              max="${formulatedQty}"
              value="${order.total_ltr_kg}"
              step="0.01"
              style="width: 100px; padding: 0.5rem; text-align: center; border: 2px solid #1a5f23; border-radius: 6px; font-weight: 600;">
      </td>
      <td style="text-align: center; color: #d97706; font-weight: 600;" id="extraCount_0">0.00</td>
      <td style="text-align: center;">
        <div style="font-weight: 600;" id="totalLtr_0">${order.total_ltr_kg.toFixed(2)}</div>
        <div style="font-size: 0.75rem; color: #64748b;">Ltr/Kg</div>
      </td>
    `;
    tableBody.appendChild(tr);
  }
  
  // Add event listeners for pack quantity changes
  document.querySelectorAll('.pack-now-input').forEach(input => {
    input.addEventListener('input', updatePackingCalculations);
  });
  
  // Initialize calculations
  updatePackingCalculations();
  
  document.getElementById('packingModal').style.display = 'flex';
}
function updatePackingCalculations() {
  const inputs = document.querySelectorAll('.pack-now-input');
  let totalPackedLtr = 0;
  let totalExtraBoxes = 0;
  let totalExtraLtr = 0;
  
  inputs.forEach(input => {
    const index = input.dataset.index;
    const packedValue = parseFloat(input.value) || 0;
    const orderedQty = parseFloat(input.dataset.ordered) || 0;
    const perBoxQty = parseFloat(input.dataset.perbox) || 1;
    const isBulk = input.dataset.isbulk === 'true';
    
    // Update packed count
    document.getElementById(`packedCount_${index}`).textContent = 
      isBulk ? packedValue.toFixed(2) : Math.floor(packedValue);
    
    // Calculate remaining
    const remaining = Math.max(0, orderedQty - packedValue);
    document.getElementById(`remainingCount_${index}`).textContent = 
      isBulk ? remaining.toFixed(2) : Math.floor(remaining);
    
    // Calculate extra (packed beyond ordered)
    const extra = Math.max(0, packedValue - orderedQty);
    document.getElementById(`extraCount_${index}`).textContent = 
      isBulk ? extra.toFixed(2) : Math.floor(extra);
    
    // Calculate total Ltr/Kg for this line
    const totalLtr = packedValue * perBoxQty;
    document.getElementById(`totalLtr_${index}`).textContent = totalLtr.toFixed(2);
    
    // Accumulate totals
    totalPackedLtr += totalLtr;
    
    if (!isBulk) {
      totalExtraBoxes += extra;
      totalExtraLtr += extra * perBoxQty;
    } else {
      totalExtraLtr += extra; // For bulk, extra is already in Ltr/Kg
    }
  });
  
  // Update total formulated display
  const totalFormulated = parseFloat(document.getElementById('packingModal').dataset.totalFormulated) || 0;
  
  // Update display values
  document.getElementById('totalPackedLtrDisplay').textContent = totalPackedLtr.toFixed(2) + ' Ltr/Kg';
  
  // Calculate bulk leftover (only for box orders)
  const bulkLeftover = Math.max(0, totalFormulated - totalPackedLtr);
  document.getElementById('bulkLeftoverDisplay').textContent = bulkLeftover.toFixed(2) + ' Ltr/Kg';
  
  // Update extra boxes display
  document.getElementById('extraBoxesDisplay').textContent = totalExtraBoxes + ' boxes';
  document.getElementById('extraToInventoryDisplay').textContent = totalExtraLtr.toFixed(2) + ' Ltr/Kg';
}
    // ===== NEW: SHOW INVENTORY DISPATCH MODAL =====
    function showInventoryDispatchModal(inventoryId, inventoryType) {
      const modal = document.getElementById('inventoryDispatchModal');
      let inventoryItem;
      
      if (inventoryType === 'box') {
        inventoryItem = APP.boxInventory.find(b => b.id === inventoryId);
      } else {
        inventoryItem = APP.bulkInventory.find(b => b.id === inventoryId);
      }
      
      if (!inventoryItem) {
        showToast('Inventory item not found', 'error');
        return;
      }
      
      // Populate modal with inventory data
      document.getElementById('dispatchInventoryCustomer').textContent = inventoryItem.customer;
      document.getElementById('dispatchInventoryProduct').textContent = inventoryItem.product;
      document.getElementById('dispatchInventoryType').textContent = inventoryType === 'box' ? `üì¶ Box (${inventoryItem.packing_size})` : 'üß¥ Bulk';
      
      if (inventoryType === 'box') {
        document.getElementById('dispatchInventoryAvailable').textContent = inventoryItem.available_boxes + ' boxes';
      } else {
        document.getElementById('dispatchInventoryAvailable').textContent = inventoryItem.available_qty.toFixed(2) + ' Ltr/Kg';
      }
      
      // Auto-fill user and date
      document.getElementById('dispatchInventoryBy').value = APP.currentUser ? APP.currentUser.username : 'Unknown';
      document.getElementById('dispatchInventoryDate').valueAsDate = new Date();
      document.getElementById('dispatchInventoryQty').value = '';
      document.getElementById('dispatchInventoryDescription').value = '';
      
      // Store inventory details for save handler
      modal.dataset.inventoryId = inventoryId;
      modal.dataset.inventoryType = inventoryType;
      
      modal.style.display = 'flex';
    }

    // ===== NEW: INVENTORY SECTION FUNCTIONS =====
    function renderBoxInventory() {
      // Ensure all required columns are shown with proper headers
      const thead = document.querySelector('#boxInventoryTable thead tr');
      if (!thead.innerHTML.includes('Per Box')) {
        thead.innerHTML = `
          <th>Company</th>
          <th>Technical Name</th>
          <th>Product</th>
          <th>Packing Size</th>
          <th>Pieces/Box</th>
          <th>Per Box Qty (Ltr/Kg)</th>
          <th>Available Boxes</th>
          <th>Total Ltr/Kg (Calculated)</th>
          <th>Last Updated</th>
          <th>Action</th>
        `;
      }
      
      const tbody = document.querySelector('#boxInventoryTable tbody');
      tbody.innerHTML = '';
      
      if (APP.boxInventory.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center" style="padding: 2rem;">
              <div style="color: var(--text-muted);">üì¶ No box inventory yet</div>
            </td>
          </tr>
        `;
        return;
      }
      
      APP.boxInventory.forEach(item => {
        // FIX: Always calculate from source values, never display stored pre-calculated Ltr/Kg
        // MANDATORY FORMULA: totalLtrKg = availableBoxes √ó perBoxQty
        const derivedTotalLtrKg = calculateBoxInventoryTotalLtrKg(item.availableBoxes || 0, item.perBoxQty || 0);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.customer}</td>
          <td style="font-weight: 600; color: #7c3aed;">‚öóÔ∏è ${item.technical_name || 'Unknown'}</td>
          <td>${item.product}</td>
          <td>${item.packing_size}</td>
          <td>${(item.piecesPerBox || 0).toFixed(2)}</td>
          <td><strong>${(item.perBoxQty || 0).toFixed(2)}</strong> Ltr/Kg</td>
          <td style="text-align: center;"><strong style="color: #0891b2;">${(item.availableBoxes || 0).toFixed(0)}</strong> boxes</td>
          <td style="background-color: #f0fdf4;">
            <strong style="color: #059669; font-size: 1.1rem;">${derivedTotalLtrKg.toFixed(2)}</strong> Ltr/Kg
            <br><span style="font-size: 0.75rem; color: #666;">(${(item.availableBoxes || 0).toFixed(0)} √ó ${(item.perBoxQty || 0).toFixed(2)})</span>
          </td>
          <td>${new Date(item.last_updated).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="showInventoryDispatchModal('${item.id}', 'box')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">üöö Dispatch</button>
            <button class="btn btn-success btn-sm" onclick="showUseStockInOrderModal('${item.id}', 'box')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üì¶ Use in Order</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderBulkInventory() {
      const thead = document.querySelector('#bulkInventoryTable thead tr');
      if (!thead.innerHTML.includes('Technical Name')) {
        thead.innerHTML = `
          <th>Company</th>
          <th>Technical Name</th>
          <th>Product</th>
          <th>Available Qty (Ltr/Kg)</th>
          <th>Last Updated</th>
          <th>Action</th>
        `;
      }
      
      const tbody = document.querySelector('#bulkInventoryTable tbody');
      tbody.innerHTML = '';
      
      if (APP.bulkInventory.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center" style="padding: 2rem;">
              <div style="color: var(--text-muted);">üß¥ No bulk inventory yet</div>
            </td>
          </tr>
        `;
        return;
      }
      
      APP.bulkInventory.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.customer}</td>
          <td style="font-weight: 600; color: #7c3aed;">‚öóÔ∏è ${item.technical_name || item.product}</td>
          <td>${item.product}</td>
          <td><strong style="color: #059669; font-size: 1.1rem;">${(item.available_qty || 0).toFixed(2)}</strong> Ltr/Kg</td>
          <td>${new Date(item.last_updated).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="showInventoryDispatchModal('${item.id}', 'bulk')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">üöö Dispatch</button>
            <button class="btn btn-success btn-sm" onclick="showUseStockInOrderModal('${item.id}', 'bulk')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üì¶ Use in Order</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== NEW: USE INVENTORY STOCK IN ORDER FUNCTIONS =====
    function showUseStockInOrderModal(inventoryId, inventoryType) {
      const modal = document.getElementById('useStockInOrderModal');
      const inventoryItem = inventoryType === 'bulk' ? 
        APP.bulkInventory.find(b => b.id === inventoryId) : 
        APP.boxInventory.find(b => b.id === inventoryId);
      
      if (!inventoryItem) {
        showToast('Inventory item not found', 'error');
        return;
      }
      
      // Store inventory details
      modal.dataset.inventoryId = inventoryId;
      modal.dataset.inventoryType = inventoryType;
      modal.dataset.product = inventoryItem.product;
      
      // For box inventory: calculate available quantity and show box/Ltr information
      let displayInfo;
      if (inventoryType === 'box') {
        const availableBoxes = inventoryItem.availableBoxes || 0;
        const perBoxQty = inventoryItem.perBoxQty || 0;
        const totalAvailableLtrKg = calculateBoxInventoryTotalLtrKg(availableBoxes, perBoxQty);
        modal.dataset.availableQty = totalAvailableLtrKg;
        
        displayInfo = `
          <strong>${inventoryItem.product}</strong><br>
          <span style="color: #666; font-size: 0.9rem;">
            Available: <strong>${availableBoxes.toFixed(0)} boxes</strong> √ó ${perBoxQty.toFixed(2)} Ltr/Kg per box = 
            <strong style="color: #059669;">${totalAvailableLtrKg.toFixed(2)} Ltr/Kg total</strong>
          </span>
        `;
      } else {
        const availableQty = inventoryItem.available_qty || 0;
        modal.dataset.availableQty = availableQty;
        displayInfo = `
          <strong>${inventoryItem.product}</strong> - Available: ${availableQty.toFixed(2)} Ltr/Kg
        `;
      }
      
      // Show inventory info
      document.getElementById('useStockInventoryInfo').innerHTML = displayInfo;
      
      // Clear form
      document.getElementById('useStockOrderNumber').value = '';
      document.getElementById('useStockProduct').innerHTML = '<option value="">Select product from order...</option>';
      document.getElementById('useStockQty').value = '';
      document.getElementById('useStockValidation').style.display = 'none';
      
      modal.style.display = 'flex';
    }
    
    function closeUseStockModal() {
      document.getElementById('useStockInOrderModal').style.display = 'none';
    }

    // ===== NEW: INVENTORY DISPATCH FUNCTIONS =====
    function recordInventoryDispatch(dispatchData) {
      const { inventory_id, inventory_type, quantity, dispatched_by, dispatch_date, description } = dispatchData;
      
      // Find inventory item
      let inventoryItem;
      if (inventory_type === 'box') {
        inventoryItem = APP.boxInventory.find(b => b.id === inventory_id);
      } else {
        inventoryItem = APP.bulkInventory.find(b => b.id === inventory_id);
      }
      
      if (!inventoryItem) {
        showToast('Inventory item not found', 'error');
        return false;
      }
      
      // For box inventory: validate against availableBoxes, not Ltr/Kg
      let availableQty;
      if (inventory_type === 'box') {
        // FIX: Validate using boxes, not pre-calculated Ltr/Kg
        // Convert Ltr/Kg input to boxes for validation
        const perBoxQty = inventoryItem.perBoxQty || 0;
        if (perBoxQty <= 0) {
          showToast('Cannot dispatch: Invalid box configuration', 'error');
          return false;
        }
        const boxesFromQuantity = perBoxQty > 0 ? quantity / perBoxQty : 0;
        availableQty = inventoryItem.availableBoxes || 0;
        
        // Block dispatch if quantity exceeds available boxes
        if (boxesFromQuantity > availableQty) {
          showToast(`Only ${availableQty.toFixed(0)} boxes (${(availableQty * perBoxQty).toFixed(2)} Ltr/Kg) available for dispatch`, 'error');
          return false;
        }
      } else {
        availableQty = inventoryItem.available_qty || 0;
        if (quantity > availableQty) {
          showToast(`Only ${availableQty.toFixed(2)} Ltr/Kg available for dispatch`, 'error');
          return false;
        }
      }
      
      // Create dispatch record with audit trail
      const dispatchRecord = {
        id: uid('invdisp'),
        inventory_id: inventory_id,
        inventory_type: inventory_type,
        customer: inventoryItem.customer,
        product: inventoryItem.product,
        quantity_dispatched: quantity,
        dispatched_by: dispatched_by,
        dispatch_date: dispatch_date,
        description: description,
        created_at: new Date().toISOString()
      };
      
      APP.inventoryDispatchRecords.push(dispatchRecord);
      
      // Deduct from inventory and recalculate totalLtrKg for box type
      if (inventory_type === 'box') {
        // FIX: Deduct ONLY boxes from availableBoxes, never from pre-calculated Ltr/Kg
        const perBoxQty = inventoryItem.perBoxQty || 0;
        const boxesToDeduct = perBoxQty > 0 ? quantity / perBoxQty : 0;
        inventoryItem.availableBoxes = (inventoryItem.availableBoxes || 0) - boxesToDeduct;
        
        // CRITICAL: Recalculate totalLtrKg using calculation function
        // Formula: totalLtrKg = availableBoxes √ó perBoxQty
        inventoryItem.totalLtrKg = calculateBoxInventoryTotalLtrKg(inventoryItem.availableBoxes, inventoryItem.perBoxQty);
        
        // Remove inventory entry if empty (no negative inventory)
        if (inventoryItem.availableBoxes <= 0) {
          const idx = APP.boxInventory.indexOf(inventoryItem);
          if (idx > -1) APP.boxInventory.splice(idx, 1);
        } else {
          inventoryItem.last_updated = new Date().toISOString();
        }
      } else {
        inventoryItem.available_qty = (inventoryItem.available_qty || 0) - quantity;
        
        // Remove inventory entry if empty
        if (inventoryItem.available_qty <= 0) {
          const idx = APP.bulkInventory.indexOf(inventoryItem);
          if (idx > -1) APP.bulkInventory.splice(idx, 1);
        } else {
          inventoryItem.last_updated = new Date().toISOString();
        }
      }
      
      saveToStorage();
      showToast('‚úì Inventory dispatched successfully');
      return true;
    }

    // ===== DISPATCH SECTION =====
    function renderOrders() {
      const container = document.getElementById('ordersContainer');
      const filter = document.getElementById('filter_status').value;
      const search = document.getElementById('filter_text').value.trim().toLowerCase();
      
      
      console.log('=== renderOrders (Dispatch) called ===');
      console.log('Search value:', search);
      console.log('Filter value:', filter);
      console.log('Total orders:', APP.orders.length);
      
      container.innerHTML = '';
      
      // Filter orders
      const filteredOrders = APP.orders.filter(order => {
        // In renderOrders() function, add this filter:
const filteredOrders = APP.orders.filter(order => {
    // Check if order has been packed
    const packingStatus = getPackingStatus(order.id);
    if (packingStatus !== 'completed') return false; // Only show packed orders
    
    // ... rest of your filters
});
        // Apply search filter
        if (search) {
          const matchesOrderNumber = order.order_number.toLowerCase().includes(search);
          const matchesCustomer = order.customer_name.toLowerCase().includes(search);
          if (!matchesOrderNumber && !matchesCustomer) return false;
        }
        return true;
      }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      console.log('Orders after search filter:', filteredOrders.length);
      
      if (filteredOrders.length === 0) {
        container.innerHTML = '<div class="text-center text-muted" style="padding: 3rem;">No orders found</div>';
        return;
      }
      
      // Process each order
      filteredOrders.forEach(order => {
        const remaining = computeOrderRemaining(order, APP.dispatches);
        const status = remaining === 0 ? 'completed' : 'pending';
        
        // Apply status filter
        if (filter === 'pending' && status !== 'pending') return;
        if (filter === 'completed' && status !== 'completed') return;
        
        // Calculate dispatch summary
        let totalOrdered = 0;
        let totalDispatched = 0;
        
        if (order.order_type === 'box') {
          totalOrdered = order.total_boxes;
          totalDispatched = order.total_boxes - remaining;
        } else {
          totalOrdered = order.total_ltr_kg;
          const dispatched = APP.dispatches
            .filter(d => d.order_id === order.id)
            .reduce((sum, d) => sum + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
          totalDispatched = dispatched;
        }
        
        const statusColors = {
          pending: 'badge-warning',
          completed: 'badge-success'
        };
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '1rem';
        card.style.borderLeft = `4px solid ${status === 'completed' ? '#059669' : '#d97706'}`;
        card.style.padding = '1.25rem';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <strong style="font-size: 1.1rem;">${order.order_number}</strong>
                <span class="badge ${statusColors[status]}" style="font-size: 0.7rem;">
                  ${status.toUpperCase()}
                </span>
                <span class="badge badge-primary" style="font-size: 0.7rem;">
                  ${order.order_type === 'box' ? 'BOX' : 'BULK'}
                </span>
              </div>
              <div class="text-muted" style="margin-bottom: 0.75rem; font-size: 0.9rem;">
                ${order.customer_name} ‚Ä¢ ${order.order_date}
              </div>
              <div style="display: flex; gap: 1.5rem; font-size: 0.85rem;">
                <div>Ordered: <strong>${order.order_type === 'box' ? totalOrdered + ' boxes' : totalOrdered.toFixed(2) + ' Ltr/Kg'}</strong></div>
                <div>Dispatched: <strong>${order.order_type === 'box' ? totalDispatched + ' boxes' : totalDispatched.toFixed(2) + ' Ltr/Kg'}</strong></div>
                <div>Remaining: <strong>${order.order_type === 'box' ? remaining + ' boxes' : remaining.toFixed(2) + ' Ltr/Kg'}</strong></div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              ${status !== 'completed' ? `
                <button class="btn btn-success btn-sm completeOrder" data-orderid="${order.id}" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                  Complete
                </button>
                <button class="btn btn-primary btn-sm showDispatch" data-orderid="${order.id}" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                  Dispatch
                </button>
              ` : ''}
              <button class="btn btn-outline btn-sm showDetail" data-orderid="${order.id}" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                Details
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(card);
        
        // Bind event listeners
        const completeBtn = card.querySelector('.completeOrder');
        const dispatchBtn = card.querySelector('.showDispatch');
        const detailBtn = card.querySelector('.showDetail');
        
        if (completeBtn) {
          completeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showForceCompleteModal(order);
          });
        }
        
        if (dispatchBtn) {
          dispatchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showDispatchModal(order.id);
          });
        }
        
        if (detailBtn) {
          detailBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showOrderDetail(order.id);
          });
        }
      });
      
      if (container.innerHTML === '') {
        container.innerHTML = '<div class="text-center text-muted" style="padding: 3rem;">No orders match your filters</div>';
      }
    }

    function showForceCompleteModal(order) {
      const remaining = computeOrderRemaining(order, APP.dispatches);
      const modal = document.getElementById('forceCompleteModal');
      
      document.getElementById('remainingBoxesCount').textContent = 
        order.order_type === 'box' ? remaining + ' boxes' : remaining.toFixed(2) + ' Ltr/Kg';
      
      modal.classList.add('active');
      APP.currentOrderId = order.id;
      APP.currentRemaining = remaining;
    }

    function markOrderComplete(orderId, force = false, reason = '', notes = '') {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return;
      
      // Get current remaining
      const remaining = computeOrderRemaining(order, APP.dispatches);
      
      order.completed_at = new Date().toISOString();
      
      if (force && remaining > 0) {
        order.force_completed = true;
        order.completion_reason = reason;
        order.completion_notes = notes;
        
        // Add remaining to dispatches as force-completed
        if (order.order_type === 'box') {
          for (const line of order.lines) {
            const lineDispatches = APP.dispatches.filter(d => d.order_id === order.id && (d.order_line_id === line.id || d.product_name === line.product_name));
            const dispatched = lineDispatches.reduce((sum, d) => sum + Number(d.dispatched_boxes || 0), 0);
            const lineRemaining = Math.max(0, line.boxes - dispatched);
            
            if (lineRemaining > 0) {
              const dispatch = {
                id: uid('D'),
                order_id: orderId,
                order_line_id: line.id,
                product_name: line.product_name,
                dispatched_boxes: lineRemaining,
                dispatched_ltr_kg: lineRemaining * line.pieces_per_box * line.packing_size,
                dispatch_date: new Date().toISOString().slice(0, 10),
                type: 'force_completed',
                notes: `Force completed: ${reason} - ${notes}`,
                created_at: new Date().toISOString()
              };
              APP.dispatches.push(dispatch);
            }
          }
        } else {
          // Bulk order
          const line = order.lines[0];
          const dispatched = APP.dispatches
            .filter(d => d.order_id === order.id)
            .reduce((sum, d) => sum + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
          const lineRemaining = Math.max(0, line.quantity_ltr_kg - dispatched);
          
          if (lineRemaining > 0) {
            const dispatch = {
              id: uid('D'),
              order_id: orderId,
              product_name: line.product_name,
              dispatched_ltr_kg: lineRemaining,
              dispatch_date: new Date().toISOString().slice(0, 10),
              type: 'force_completed',
              notes: `Force completed: ${reason} - ${notes}`,
              created_at: new Date().toISOString()
            };
            APP.dispatches.push(dispatch);
          }
        }
      }
      
      saveToStorage();
      renderOrders();
      
      if (force) {
        showToast('Order force completed');
      } else {
        showToast('Order marked as completed');
      }
    }

    function showDispatchModal(orderId) {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return;
      
      document.getElementById('dispatchOrderNumber').textContent = order.order_number;
      document.getElementById('dispatchCustomer').textContent = order.customer_name;
      document.getElementById('dispatchOrderDate').textContent = order.order_date;
      
      const dispatchLines = document.getElementById('dispatchLines');
      dispatchLines.innerHTML = '';
      
      if (order.order_type === 'box') {
        // Box order dispatch
        order.lines.forEach(line => {
          const lineDispatches = APP.dispatches.filter(d => d.order_id === order.id && (d.order_line_id === line.id || d.product_name === line.product_name));
          const dispatched = lineDispatches.reduce((sum, d) => sum + Number(d.dispatched_boxes || 0), 0);
          const remaining = Math.max(0, line.boxes - dispatched);
          
          if (remaining > 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${line.product_name}</td>
              <td>${line.boxes}</td>
              <td>${dispatched}</td>
              <td>${remaining}</td>
              <td>
                <input type="number" 
                       min="1" 
                       max="${remaining}" 
                       value="${remaining}" 
                       style="width: 80px; padding: 0.5rem; border: 2px solid var(--border); border-radius: 6px;"
                       data-lineid="${line.id}"
                       data-product="${line.product_name}">
              </td>
            `;
            dispatchLines.appendChild(tr);
          }
        });
      } else {
        // Bulk order dispatch
        const line = order.lines[0];
        const dispatched = APP.dispatches
          .filter(d => d.order_id === order.id)
          .reduce((sum, d) => sum + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
        const remaining = Math.max(0, line.quantity_ltr_kg - dispatched);
        
        if (remaining > 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${line.product_name}</td>
            <td>${line.quantity_ltr_kg.toFixed(2)} Ltr/Kg</td>
            <td>${dispatched.toFixed(2)} Ltr/Kg</td>
            <td>${remaining.toFixed(2)} Ltr/Kg</td>
            <td>
              <input type="number" 
                     step="0.01"
                     min="0.01" 
                     max="${remaining}" 
                     value="${remaining.toFixed(2)}" 
                     style="width: 100px; padding: 0.5rem; border: 2px solid var(--border); border-radius: 6px;"
                     data-lineid="${line.id}"
                     data-product="${line.product_name}">
            </td>
          `;
          dispatchLines.appendChild(tr);
        }
      }
      
      if (dispatchLines.innerHTML === '') {
        dispatchLines.innerHTML = `
          <tr>
            <td colspan="5" class="text-center" style="padding: 2rem;">
              <div class="text-muted">No items available for dispatch</div>
            </td>
          </tr>
        `;
        document.getElementById('saveDispatch').disabled = true;
      } else {
        document.getElementById('saveDispatch').disabled = false;
      }
      
      document.getElementById('dispatchDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('dispatchModal').classList.add('active');
      APP.currentOrderId = orderId;
    }

    function closeDispatchModal() {
      document.getElementById('dispatchModal').classList.remove('active');
    }

    function showOrderDetail(orderId) {
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const customer = APP.customers.find(c => c.id === order.customer_id) || {};
      const remaining = computeOrderRemaining(order, APP.dispatches);
      const status = remaining === 0 ? 'completed' : 'pending';
      
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Order Detail - ${order.order_number}</title>
          <style>
            body { font-family: 'Inter', sans-serif; padding: 2rem; background: #f8fafc; }
            .header { text-align: center; margin-bottom: 2rem; }
            .company-header { background: linear-gradient(135deg, #1a5f23 0%, #2d8c3a 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
            .info-box { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
            table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
            th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
            th { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
            .status-badge { padding: 0.375rem 0.875rem; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }
            .pending { background: #fef3c7; color: #92400e; }
            .completed { background: #d1fae5; color: #065f46; }
          </style>
        </head>
        <body>
          <div class="company-header">
            <h1 style="margin: 0 0 0.5rem 0;">Tyrone Agrochemicals Private Limited</h1>
            <h2 style="margin: 0; opacity: 0.9;">Order Detail Report</h2>
          </div>
          
          <div class="header">
            <h1 style="margin: 0 0 0.5rem 0;">${order.order_number}</h1>
            <div class="status-badge ${status}">${status.toUpperCase()}</div>
            <p style="margin: 0.5rem 0; color: #64748b;">Generated on: ${new Date().toLocaleDateString()}</p>
          </div>
          
          <div class="info-grid">
            <div class="info-box">
              <h3 style="margin: 0 0 1rem 0; color: #1e293b;">Customer Information</h3>
              <p><strong>Company:</strong> ${customer.company || 'N/A'}</p>
              <p><strong>Contact:</strong> ${customer.contact || 'N/A'}</p>
              <p><strong>Phone:</strong> ${customer.phone || 'N/A'}</p>
              <p><strong>Address:</strong> ${customer.address || 'N/A'}</p>
            </div>
            
            <div class="info-box">
              <h3 style="margin: 0 0 1rem 0; color: #1e293b;">Order Information</h3>
              <p><strong>Order Date:</strong> ${order.order_date}</p>
              <p><strong>Expected Delivery:</strong> ${order.delivery_date || 'N/A'}</p>
              <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
              ${order.completed_at ? `<p><strong>Completed:</strong> ${new Date(order.completed_at).toLocaleString()}</p>` : ''}
              ${order.formulation_completed_at ? `<p><strong>Formulation Completed:</strong> ${new Date(order.formulation_completed_at).toLocaleString()}</p>` : ''}
              ${order.force_completed ? `<p><strong>Force Completed:</strong> Yes</p>` : ''}
              ${order.completion_reason ? `<p><strong>Reason:</strong> ${order.completion_reason}</p>` : ''}
              ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
            </div>
          </div>
          
          <h3 style="color: #1e293b; margin-bottom: 1rem;">Order Items</h3>
          <table>
            <thead>
              <tr>
      `;
      
      if (order.order_type === 'box') {
        html += `
                <th>Product</th>
                <th>Packing Size</th>
                <th>Pieces per Box</th>
                <th>Boxes</th>
                <th>Total Ltr/Kg</th>
                <th>Formulation Status</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        order.lines.forEach(line => {
          const dispatched = APP.dispatches
            .filter(d => d.order_id === order.id && (d.order_line_id === line.id || d.product_name === line.product_name))
            .reduce((sum, d) => sum + Number(d.dispatched_boxes || 0), 0);
          const remaining = Math.max(0, line.boxes - dispatched);
          const formulationStatus = order.line_formulation_status ? order.line_formulation_status[line.id] || 'pending' : 'pending';
          
          html += `
            <tr>
              <td>${line.product_name}</td>
              <td>${line.packing_size} Ltr/Kg</td>
              <td>${line.pieces_per_box}</td>
              <td>${line.boxes} (${dispatched} dispatched, ${remaining} remaining)</td>
              <td>${line.total_ltr_kg.toFixed(2)}</td>
              <td><span class="status-badge ${formulationStatus === 'completed' ? 'completed' : 'pending'}">${formulationStatus.toUpperCase()}</span></td>
            </tr>
          `;
        });
      } else {
        html += `
                <th>Product</th>
                <th>Description</th>
                <th>Quantity (Ltr/Kg)</th>
                <th>Formulation Status</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        const line = order.lines[0];
        const dispatched = APP.dispatches
          .filter(d => d.order_id === order.id)
          .reduce((sum, d) => sum + Number(d.dispatched_ltr_kg || d.dispatched_boxes || 0), 0);
        const remaining = Math.max(0, line.quantity_ltr_kg - dispatched);
        const formulationStatus = order.line_formulation_status ? order.line_formulation_status[line.id] || 'pending' : 'pending';
        
        html += `
          <tr>
            <td>${line.product_name}</td>
            <td>${line.description || 'N/A'}</td>
            <td>${line.quantity_ltr_kg.toFixed(2)} (${dispatched.toFixed(2)} dispatched, ${remaining.toFixed(2)} remaining)</td>
            <td><span class="status-badge ${formulationStatus === 'completed' ? 'completed' : 'pending'}">${formulationStatus.toUpperCase()}</span></td>
          </tr>
        `;
      }
      
      html += `
            </tbody>
          </table>
          
          <h3 style="color: #1e293b; margin-bottom: 1rem;">Dispatch History</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th>
      `;
      
      if (order.order_type === 'box') {
        html += `<th>Product</th><th>Boxes</th>`;
      } else {
        html += `<th>Product</th><th>Ltr/Kg</th>`;
      }
      
      html += `
                <th>LR Number</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      const orderDispatches = APP.dispatches
        .filter(d => d.order_id === order.id)
        .sort((a, b) => new Date(b.dispatch_date) - new Date(a.dispatch_date));
      
      if (orderDispatches.length === 0) {
        html += `<tr><td colspan="5" style="text-align: center; padding: 2rem;">No dispatches recorded</td></tr>`;
      } else {
        orderDispatches.forEach(dispatch => {
          const dispatchedValue = order.order_type === 'box' 
            ? (dispatch.dispatched_boxes || 0)
            : (dispatch.dispatched_ltr_kg || dispatch.dispatched_boxes || 0).toFixed(2);
            
          html += `
            <tr>
              <td>${dispatch.dispatch_date}</td>
              <td>${dispatch.product_name || 'N/A'}</td>
              <td>${dispatchedValue}</td>
              <td>${dispatch.lr_number || 'N/A'}</td>
              <td>${dispatch.notes || 'N/A'}</td>
            </tr>
          `;
        });
      }
      
      html += `
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
    }

    // ===== EVENT LISTENERS =====
    // Login
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // Logout button - use event delegation for reliability
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'logoutBtn') {
        logout();
      }
    });

    // Dashboard navigation
    document.getElementById('masterDataCard').addEventListener('click', () => {
      showSection('masterDataSection');
    });
    
    document.getElementById('createOrderCard').addEventListener('click', () => {
      showSection('createOrderSection');
    });
    
    document.getElementById('ordersCard').addEventListener('click', () => {
      showSection('ordersSection');
    });
    
    document.getElementById('formulationCard').addEventListener('click', () => {
      showSection('formulationSection');
    });
    
    // ===== NEW: PACKING & INVENTORY CARD LISTENERS =====
    document.getElementById('packingCard').addEventListener('click', () => {
      showSection('packingSection');
    });
    
    document.getElementById('inventoryCard').addEventListener('click', () => {
      showSection('inventorySection');
    });
    
    document.getElementById('dispatchCard').addEventListener('click', () => {
      showSection('dispatchSection');
    });

    // Modal handlers
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('forceCompleteModal').classList.remove('active');
    });
    
    document.getElementById('cancelComplete').addEventListener('click', () => {
      document.getElementById('forceCompleteModal').classList.remove('active');
    });
    
    document.getElementById('confirmForceComplete').addEventListener('click', () => {
      const reason = document.getElementById('completeReason').value;
      const notes = document.getElementById('completeNotes').value.trim();
      
      markOrderComplete(APP.currentOrderId, true, reason, notes);
      document.getElementById('forceCompleteModal').classList.remove('active');
      
      // Clear modal fields
      document.getElementById('completeNotes').value = '';
    });

    // Dispatch modal handlers
    document.querySelectorAll('.closeDispatchModal').forEach(btn => {
      btn.addEventListener('click', closeDispatchModal);
    });

    document.getElementById('saveDispatch').addEventListener('click', () => {
      const orderId = APP.currentOrderId;
      const order = APP.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const dispatchDate = document.getElementById('dispatchDate').value;
      const lrNumber = document.getElementById('lrNumber').value.trim();
      const notes = document.getElementById('dispatchNotes').value.trim();
      
      let hasDispatch = false;
      
      if (order.order_type === 'box') {
        const inputs = document.querySelectorAll('#dispatchLines input[data-lineid]');
        inputs.forEach(input => {
          const qty = parseInt(input.value);
          if (qty > 0) {
            const line = order.lines.find(l => l.id === input.dataset.lineid);
            if (!line) return;
            
            const dispatch = {
              id: uid('DISP'),
              order_id: orderId,
              order_line_id: input.dataset.lineid,
              product_name: input.dataset.product,
              dispatched_boxes: qty,
              dispatched_ltr_kg: qty * line.pieces_per_box * line.packing_size,
              dispatch_date: dispatchDate,
              lr_number: lrNumber,
              notes: notes,
              created_at: new Date().toISOString()
            };
            APP.dispatches.push(dispatch);
            hasDispatch = true;
          }
        });
      } else {
        const input = document.querySelector('#dispatchLines input[data-lineid]');
        if (input) {
          const qty = parseFloat(input.value);
          if (qty > 0) {
            const dispatch = {
              id: uid('DISP'),
              order_id: orderId,
              order_line_id: input.dataset.lineid,
              product_name: input.dataset.product,
              dispatched_ltr_kg: qty,
              dispatch_date: dispatchDate,
              lr_number: lrNumber,
              notes: notes,
              created_at: new Date().toISOString()
            };
            APP.dispatches.push(dispatch);
            hasDispatch = true;
          }
        }
      }
      
      if (hasDispatch) {
        saveToStorage();
        showToast('Dispatch recorded successfully');
        renderOrders();
        closeDispatchModal();
      }
    });

    // Refresh orders
    document.getElementById('refreshOrders').addEventListener('click', () => {
      renderOrders();
      showToast('Orders list refreshed');
    });

    // ===== NEW: PACKING MODAL HANDLERS =====
    function closePackingModal() {
      document.getElementById('packingModal').style.display = 'none';
    }

    document.querySelectorAll('.closePackingModal').forEach(btn => {
      btn.addEventListener('click', closePackingModal);
    });

   document.getElementById('savePacking').addEventListener('click', () => {
  const orderId = document.getElementById('packingModal').dataset.orderId;
  const order = APP.orders.find(o => o.id === orderId);
  
  if (!order) {
    showToast('Order not found', 'error');
    return;
  }
  
  const packingDate = document.getElementById('packingDate').value;
  const notes = document.getElementById('packingNotes').value.trim();
  const packedBy = document.getElementById('packedBy').value.trim();
  
  // Collect packed items from table
  const packedItems = [];
  let totalPackedLtr = 0;
  let totalExtraBoxes = 0;
  let totalExtraLtr = 0;
  const bulkLeftovers = {};
  
  document.querySelectorAll('.pack-now-input').forEach(input => {
    const index = input.dataset.index;
    const packedValue = parseFloat(input.value) || 0;
    const perBoxQty = parseFloat(input.dataset.perbox) || 1;
    const isBulk = input.dataset.isbulk === 'true';
    
    if (packedValue > 0) {
      // For box orders, find the matching line
      if (!isBulk && order.lines && order.lines.length > 0) {
        // Simplified: just get the first line for now
        const line = order.lines[0];
        packedItems.push({
          line_id: line.id,
          product_name: line.product_name,
          technical_name: line.technical_name,
          packing_size: line.packing_size,
          pieces_per_box: line.pieces_per_box,
          packed_boxes: packedValue,
          perBoxQty: perBoxQty
        });
        
        // Calculate extra
        const orderedQty = parseFloat(input.dataset.ordered) || 0;
        const extra = Math.max(0, packedValue - orderedQty);
        totalExtraBoxes += extra;
        totalExtraLtr += extra * perBoxQty;
      }
      
      totalPackedLtr += packedValue * perBoxQty;
    }
  });
  
  if (packedItems.length === 0) {
    showToast('Please pack at least one item', 'error');
    return;
  }
  
  // Calculate bulk leftover
  const totalFormulated = parseFloat(document.getElementById('packingModal').dataset.totalFormulated) || 0;
  const bulkLeftover = Math.max(0, totalFormulated - totalPackedLtr);
  
  // Store bulk leftover by technical name
  if (bulkLeftover > 0 && order.lines && order.lines.length > 0) {
    const technicalName = order.lines[0].technical_name;
    bulkLeftovers[technicalName] = bulkLeftover;
  }
  
  const packingData = {
    order_id: orderId,
    order_number: order.order_number,
    customer_name: order.customer_name,
    packed_items: packedItems,
    packed_by: packedBy,
    packing_date: packingDate,
    notes: notes,
    total_packed_ltr: totalPackedLtr,
    extra_boxes: totalExtraBoxes,
    extra_ltr: totalExtraLtr,
    bulk_leftovers: bulkLeftovers,
    created_at: new Date().toISOString()
  };
  
  // Save to packing records
  APP.packingRecords.push({
    id: uid('pack'),
    ...packingData
  });
  
  // Update inventory with extra boxes
  if (totalExtraBoxes > 0 && order.lines && order.lines.length > 0) {
    const line = order.lines[0];
    const perBoxQty = line.perBoxQty || (line.packing_size * line.pieces_per_box);
    
    // Find or create box inventory
    const existingInv = APP.boxInventory.find(b => 
      b.customer === order.customer_name && 
      b.product === line.product_name &&
      b.technical_name === line.technical_name &&
      b.packing_size === line.packing_size
    );
    
    if (existingInv) {
      existingInv.availableBoxes += totalExtraBoxes;
      existingInv.totalLtrKg = calculateBoxInventoryTotalLtrKg(existingInv.availableBoxes, existingInv.perBoxQty);
      existingInv.last_updated = new Date().toISOString();
    } else {
      APP.boxInventory.push({
        id: uid('boxinv'),
        customer: order.customer_name,
        product: line.product_name,
        technical_name: line.technical_name,
        packing_size: line.packing_size,
        piecesPerBox: line.pieces_per_box,
        perBoxQty: perBoxQty,
        availableBoxes: totalExtraBoxes,
        totalLtrKg: calculateBoxInventoryTotalLtrKg(totalExtraBoxes, perBoxQty),
        last_updated: new Date().toISOString()
      });
    }
  }
  
  // Update inventory with bulk leftover
  if (bulkLeftover > 0 && order.lines && order.lines.length > 0) {
    const technicalName = order.lines[0].technical_name;
    
    // Find or create bulk inventory
    const existingBulk = APP.bulkInventory.find(b => 
      b.customer === order.customer_name && 
      b.technical_name === technicalName
    );
    
    if (existingBulk) {
      existingBulk.available_qty += bulkLeftover;
      existingBulk.last_updated = new Date().toISOString();
    } else {
      APP.bulkInventory.push({
        id: uid('bulkinv'),
        customer: order.customer_name,
        technical_name: technicalName,
        product: technicalName,
        available_qty: bulkLeftover,
        last_updated: new Date().toISOString()
      });
    }
  }
  
  saveToStorage();
  showToast('‚úì Packing completed successfully');
  
  // Refresh displays
  renderPackingTable();
  renderBoxInventory();
  renderBulkInventory();
  closePackingModal();
});
    // Packing search listeners
    const packingSearchOrder = document.getElementById('packing_search_order');
    const packingSearchCustomer = document.getElementById('packing_search_customer');
    
    if (packingSearchOrder) {
      packingSearchOrder.addEventListener('input', function(e) {
        console.log('Packing: Searching by Order Number:', e.target.value);
        renderPackingTable();
      });
    }
    
    if (packingSearchCustomer) {
      packingSearchCustomer.addEventListener('input', function(e) {
        console.log('Packing: Searching by Customer Name:', e.target.value);
        renderPackingTable();
      });
    }

    // ===== NEW: INVENTORY TAB HANDLERS =====
    const inventoryTabBox = document.getElementById('inventoryTabBox');
    const inventoryTabBulk = document.getElementById('inventoryTabBulk');
    const boxInventoryView = document.getElementById('boxInventoryView');
    const bulkInventoryView = document.getElementById('bulkInventoryView');
    
    if (inventoryTabBox) {
      inventoryTabBox.addEventListener('click', () => {
        boxInventoryView.style.display = 'block';
        bulkInventoryView.style.display = 'none';
        inventoryTabBox.style.borderBottomColor = '#1a5f23';
        inventoryTabBox.style.color = '#1a5f23';
        inventoryTabBulk.style.borderBottom = 'none';
        inventoryTabBulk.style.color = 'var(--text)';
        renderBoxInventory();
      });
    }
    
    if (inventoryTabBulk) {
      inventoryTabBulk.addEventListener('click', () => {
        boxInventoryView.style.display = 'none';
        bulkInventoryView.style.display = 'block';
        inventoryTabBulk.style.borderBottom = '3px solid #1a5f23';
        inventoryTabBulk.style.color = '#1a5f23';
        inventoryTabBox.style.borderBottomColor = '#e2e8f0';
        inventoryTabBox.style.color = 'var(--text)';
        renderBulkInventory();
      });
    }

    // ===== NEW: INVENTORY DISPATCH EVENT LISTENERS =====
    function closeInventoryDispatchModal() {
      document.getElementById('inventoryDispatchModal').style.display = 'none';
    }

    document.querySelectorAll('.closeInventoryDispatchModal').forEach(btn => {
      btn.addEventListener('click', closeInventoryDispatchModal);
    });

    document.getElementById('saveInventoryDispatch').addEventListener('click', () => {
      const modal = document.getElementById('inventoryDispatchModal');
      const inventoryId = modal.dataset.inventoryId;
      const inventoryType = modal.dataset.inventoryType;
      
      const quantity = parseFloat(document.getElementById('dispatchInventoryQty').value);
      const dispatchedBy = document.getElementById('dispatchInventoryBy').value.trim();
      const dispatchDate = document.getElementById('dispatchInventoryDate').value;
      const description = document.getElementById('dispatchInventoryDescription').value.trim();
      
      // Validation
      if (!quantity || quantity <= 0) {
        showToast('Please enter a valid quantity to dispatch', 'error');
        return;
      }
      
      if (!description) {
        showToast('Please provide a description of where this inventory is being dispatched to', 'error');
        return;
      }
      
      // Record the dispatch
      const dispatchData = {
        inventory_id: inventoryId,
        inventory_type: inventoryType,
        quantity: quantity,
        dispatched_by: dispatchedBy,
        dispatch_date: dispatchDate,
        description: description
      };
      
      if (recordInventoryDispatch(dispatchData)) {
        // Refresh both inventory tables
        renderBoxInventory();
        renderBulkInventory();
        closeInventoryDispatchModal();
      }
    });

    // ===== NEW: USE STOCK IN ORDER EVENT LISTENERS =====
    document.querySelectorAll('.closeUseStockModal').forEach(btn => {
      btn.addEventListener('click', closeUseStockModal);
    });

    // When order number is entered, populate products from that order
    document.getElementById('useStockOrderNumber').addEventListener('blur', function() {
      const orderNum = this.value.trim().toUpperCase();
      const order = APP.orders.find(o => o.order_number === orderNum);
      
      const productSelect = document.getElementById('useStockProduct');
      productSelect.innerHTML = '<option value="">Select product from order...</option>';
      
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }
      
      // Get unique products in this order
      const products = [...new Set(order.lines.map(l => l.product_name))];
      products.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod;
        option.textContent = prod;
        productSelect.appendChild(option);
      });
    });

    // Validate when product is selected
    document.getElementById('useStockProduct').addEventListener('change', function() {
      const modal = document.getElementById('useStockInOrderModal');
      const inventoryProduct = modal.dataset.product;
      const selectedProduct = this.value;
      
      if (selectedProduct === inventoryProduct) {
        document.getElementById('useStockValidation').innerHTML = `
          <strong style="color: #16a34a;">‚úì Valid:</strong> Product matches inventory (${inventoryProduct})
        `;
        document.getElementById('useStockValidation').style.display = 'block';
      } else {
        document.getElementById('useStockValidation').style.display = 'none';
      }
    });

    // Save use stock in order
    document.getElementById('saveUseStock').addEventListener('click', function() {
      const modal = document.getElementById('useStockInOrderModal');
      const orderNum = document.getElementById('useStockOrderNumber').value.trim().toUpperCase();
      const product = document.getElementById('useStockProduct').value;
      let qty = parseFloat(document.getElementById('useStockQty').value);
      const inventoryId = modal.dataset.inventoryId;
      const inventoryType = modal.dataset.inventoryType;
      const inventoryProduct = modal.dataset.product;
      
      // Validation
      if (!orderNum) {
        showToast('Please enter order number', 'error');
        return;
      }
      
      if (!product) {
        showToast('Please select a product', 'error');
        return;
      }
      
      if (product !== inventoryProduct) {
        showToast('Selected product does not match inventory product', 'error');
        return;
      }
      
      if (!qty || qty <= 0) {
        showToast('Please enter valid quantity', 'error');
        return;
      }
      
      const availableQty = parseFloat(modal.dataset.availableQty);
      if (qty > availableQty) {
        showToast(`Cannot use more than available (${availableQty.toFixed(2)})`, 'error');
        return;
      }
      
      const order = APP.orders.find(o => o.order_number === orderNum);
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }
      
      // For box inventory: convert Ltr/Kg input to boxes, then deduct and recalculate
      // For bulk inventory: qty is already in Ltr/Kg
      let qtyInLtrKg = qty;
      
      // Record usage (always store in Ltr/Kg)
      const usageRecord = {
        id: uid('usage'),
        order_id: order.id,
        order_number: orderNum,
        product_name: product,
        inventory_id: inventoryId,
        inventory_type: inventoryType,
        qty_used: qtyInLtrKg,  // Store as Ltr/Kg
        used_by: APP.currentUser.username,
        used_date: new Date().toISOString(),
        created_at: new Date().toISOString()
      };
      
      APP.inventoryUsedInOrders.push(usageRecord);
      
      // Deduct from inventory and recalculate totalLtrKg for box type
      if (inventoryType === 'bulk') {
        const bulkItem = APP.bulkInventory.find(b => b.id === inventoryId);
        if (bulkItem) {
          bulkItem.available_qty -= qty;
          if (bulkItem.available_qty <= 0) {
            APP.bulkInventory = APP.bulkInventory.filter(b => b.id !== inventoryId);
          } else {
            bulkItem.last_updated = new Date().toISOString();
          }
        }
      } else {
        // BOX INVENTORY: FIX - Never manipulate pre-calculated Ltr/Kg
        // Always work with boxes, let inventory calculate Ltr/Kg
        const boxItem = APP.boxInventory.find(b => b.id === inventoryId);
        if (boxItem) {
          // Validate perBoxQty exists (required for calculation)
          const perBoxQty = boxItem.perBoxQty || 0;
          if (!perBoxQty || perBoxQty <= 0) {
            showToast('ERROR: Inventory item missing perBoxQty', 'error');
            return;
          }
          
          const boxesToDeduct = perBoxQty > 0 ? qty / perBoxQty : 0;
          boxItem.availableBoxes = (boxItem.availableBoxes || 0) - boxesToDeduct;
          
          // CRITICAL: Recalculate totalLtrKg using calculation function
          // Formula: totalLtrKg = availableBoxes √ó perBoxQty
          boxItem.totalLtrKg = calculateBoxInventoryTotalLtrKg(boxItem.availableBoxes, boxItem.perBoxQty);
          
          if (boxItem.availableBoxes <= 0) {
            APP.boxInventory = APP.boxInventory.filter(b => b.id !== inventoryId);
          } else {
            boxItem.last_updated = new Date().toISOString();
          }
        }
      }
      
      saveToStorage();
      showToast(`‚úì Added ${qty.toFixed(2)} to order ${orderNum}`, 'success');
      renderBulkInventory();
      renderBoxInventory();
      closeUseStockModal();
    });

    // Show All Orders button


    // ===== INITIALIZATION =====
    async function initialize() {
      // Load data from Firestore first, then fallback to localStorage
      try {
        console.log('Loading data from Firestore for user:', APP.currentUser?.uid);
        
        const [customers, products, orders, dispatches, formulations, packingRecords, boxInventory, bulkInventory, inventoryDispatchRecords, inventoryUsedInOrders] = await Promise.all([
          loadFromFirestore('customers'),
          loadFromFirestore('products'),
          loadFromFirestore('orders'),
          loadFromFirestore('dispatches'),
          loadFromFirestore('formulations'),
          loadFromFirestore('packingRecords'),
          loadFromFirestore('boxInventory'),
          loadFromFirestore('bulkInventory'),
          loadFromFirestore('inventoryDispatchRecords'),
          loadFromFirestore('inventoryUsedInOrders')
        ]);
        
        APP.customers = customers && customers.length > 0 ? customers : [];
        APP.products = products && products.length > 0 ? products : [];
        APP.orders = orders && orders.length > 0 ? orders : [];
        APP.dispatches = dispatches && dispatches.length > 0 ? dispatches : [];
        APP.formulations = formulations && formulations.length > 0 ? formulations : [];
        APP.packingRecords = packingRecords && packingRecords.length > 0 ? packingRecords : [];
        APP.boxInventory = boxInventory && boxInventory.length > 0 ? boxInventory : [];
        APP.bulkInventory = bulkInventory && bulkInventory.length > 0 ? bulkInventory : [];
        APP.inventoryDispatchRecords = inventoryDispatchRecords && inventoryDispatchRecords.length > 0 ? inventoryDispatchRecords : [];
        APP.inventoryUsedInOrders = inventoryUsedInOrders && inventoryUsedInOrders.length > 0 ? inventoryUsedInOrders : [];
        
        console.log('‚úì Data loaded from Firestore successfully');
      } catch (err) {
        console.warn('Error loading from Firestore, trying localStorage backup:', err.message);
        
        // Fallback to localStorage
        try {
          APP.customers = localStorage.getItem('tyrone_customers') ? JSON.parse(localStorage.getItem('tyrone_customers')) : [];
          APP.products = localStorage.getItem('tyrone_products') ? JSON.parse(localStorage.getItem('tyrone_products')) : [];
          APP.orders = localStorage.getItem('tyrone_orders') ? JSON.parse(localStorage.getItem('tyrone_orders')) : [];
          APP.dispatches = localStorage.getItem('tyrone_dispatches') ? JSON.parse(localStorage.getItem('tyrone_dispatches')) : [];
          APP.formulations = localStorage.getItem('tyrone_formulations') ? JSON.parse(localStorage.getItem('tyrone_formulations')) : [];
          APP.packingRecords = localStorage.getItem('tyrone_packingRecords') ? JSON.parse(localStorage.getItem('tyrone_packingRecords')) : [];
          APP.boxInventory = localStorage.getItem('tyrone_boxInventory') ? JSON.parse(localStorage.getItem('tyrone_boxInventory')) : [];
          APP.bulkInventory = localStorage.getItem('tyrone_bulkInventory') ? JSON.parse(localStorage.getItem('tyrone_bulkInventory')) : [];
          APP.inventoryDispatchRecords = localStorage.getItem('tyrone_inventoryDispatchRecords') ? JSON.parse(localStorage.getItem('tyrone_inventoryDispatchRecords')) : [];
          APP.inventoryUsedInOrders = localStorage.getItem('tyrone_inventoryUsedInOrders') ? JSON.parse(localStorage.getItem('tyrone_inventoryUsedInOrders')) : [];
          
          if (APP.customers.length > 0 || APP.orders.length > 0) {
            console.log('‚úì Data restored from localStorage backup');
            showToast('Data loaded from local cache (Firestore unavailable)', 'info');
          }
        } catch (e) {
          console.error('localStorage backup also failed:', e);
          showToast('Could not load data - starting fresh', 'warning');
          
          // Initialize with empty arrays
          APP.customers = [];
          APP.products = [];
          APP.orders = [];
          APP.dispatches = [];
          APP.formulations = [];
          APP.packingRecords = [];
          APP.boxInventory = [];
          APP.bulkInventory = [];
          APP.inventoryDispatchRecords = [];
          APP.inventoryUsedInOrders = [];
        }
      }
      
      // STEP 1: Ensure all products have technical_name (backward compatibility migration)
      APP.products.forEach(product => {
        if (!product.technical_name) {
          // If product has no technical_name, derive it from product name (fallback)
          product.technical_name = product.name + ' (Legacy)';
          console.warn('Migrated product without technical_name:', product.name);
        }
      });
      
      // Update user display
      updateUserDisplay();

      // Show dashboard by default
      showSection('dashboardSection');
      
      showToast('Tyrone Agrochemicals OMS loaded successfully');
      
      // ===== ATTACH SEARCH EVENT LISTENERS =====
      // Orders search listeners
      const ordersSearchInput = document.getElementById('orders_search');
      const ordersFilterSelect = document.getElementById('orders_filter_status');
      
      if (ordersSearchInput) {
        ordersSearchInput.addEventListener('input', function(e) {
          console.log('Orders: Searching by Order Number / Customer Name:', e.target.value);
          renderOrdersTable();
        });
      }
      
      if (ordersFilterSelect) {
        ordersFilterSelect.addEventListener('change', function(e) {
          console.log('Orders: Status filter:', e.target.value);
          renderOrdersTable();
        });
      }
      
      // Formulation search listeners
      const formSearchOrder = document.getElementById('form_search_order');
      const formSearchCustomer = document.getElementById('form_search_customer');
      const formFilterStatus = document.getElementById('form_filter_status');
      
      if (formSearchOrder) {
        formSearchOrder.addEventListener('input', function(e) {
          console.log('Formulation: Searching by Order Number:', e.target.value);
          renderFormulationTable();
        });
      }
      
      if (formSearchCustomer) {
        formSearchCustomer.addEventListener('input', function(e) {
          console.log('Formulation: Searching by Customer Name:', e.target.value);
          renderFormulationTable();
        });
      }
      
      if (formFilterStatus) {
        formFilterStatus.addEventListener('change', function(e) {
          console.log('Formulation: Status filter:', e.target.value);
          renderFormulationTable();
        });
      }
      const formSearchTechnical = document.getElementById('form_search_technical');
if (formSearchTechnical) {
  formSearchTechnical.addEventListener('input', function(e) {
    console.log('Formulation: Searching by Technical Name:', e.target.value);
    renderFormulationOrderTable();
  });
}
      // Dispatch search listeners
      const dispatchFilterText = document.getElementById('filter_text');
      const dispatchFilterStatus = document.getElementById('filter_status');
      
      if (dispatchFilterText) {
        dispatchFilterText.addEventListener('input', function(e) {
          console.log('Dispatch: Searching by Order Number / Customer Name:', e.target.value);
          renderOrders();
        });
      }
      
      if (dispatchFilterStatus) {
        dispatchFilterStatus.addEventListener('change', function(e) {
          console.log('Dispatch: Status filter:', e.target.value);
          renderOrders();
        });
      }
      
      // Formulation Refresh Button
const refreshFormulationBtn = document.getElementById('refreshFormulationBtn');
if (refreshFormulationBtn) {
  refreshFormulationBtn.addEventListener('click', function() {
    const btn = this;
    btn.style.transform = 'rotate(0deg)';
    btn.style.transition = 'transform 0.6s ease-in-out';
    
    // Animate rotation
    let rotation = 0;
    const rotationInterval = setInterval(() => {
      rotation += 360;
      btn.style.transform = `rotate(${rotation}deg)`;
      if (rotation >= 360) clearInterval(rotationInterval);
    }, 600);
    
    // Clear all search fields
    const formOrder = document.getElementById('form_search_order');
    const formCustomer = document.getElementById('form_search_customer');
    const formTechnical = document.getElementById('form_search_technical');
    
    if (formOrder) formOrder.value = '';
    if (formCustomer) formCustomer.value = '';
    if (formTechnical) formTechnical.value = '';
    
    // Refresh the table
    renderFormulationOrderTable();
    showToast('Production data refreshed');
  });
}
      
      // Show All Orders Button (Dispatch)
      const showAllOrdersBtn = document.getElementById('showAllOrdersBtn');
      if (showAllOrdersBtn) {
        showAllOrdersBtn.addEventListener('click', () => {
          document.getElementById('filter_status').value = 'all';
          document.getElementById('filter_text').value = '';
          renderOrders();
          showToast('Showing all orders');
        });
      }
      
      // Formulation Report Buttons
      const reportFormulationDate = document.getElementById('reportFormulationDate');
      const reportFormulationOrder = document.getElementById('reportFormulationOrder');
      const reportFormulationProduct = document.getElementById('reportFormulationProduct');
      
      if (reportFormulationDate) {
        reportFormulationDate.addEventListener('click', () => {
          generateFormulationReport('date');
        });
      }
      
      if (reportFormulationOrder) {
        reportFormulationOrder.addEventListener('click', () => {
          generateFormulationReport('order');
        });
      }
      
      if (reportFormulationProduct) {
        reportFormulationProduct.addEventListener('click', () => {
          generateFormulationReport('product');
        });
      }
    }
console.log(APP.formulations.map(f => f.technical_name));

    // Check if user is already logged in
    async function checkLoginStatus() {
      const savedUser = localStorage.getItem('tyrone_currentUser');
      if (savedUser) {
        try {
          APP.currentUser = JSON.parse(savedUser);
          console.log('Resuming session for:', APP.currentUser.username);
          document.getElementById('loginPage').classList.add('hidden-page');
          document.getElementById('appPage').classList.remove('hidden-page');
          await initialize();
        } catch (e) {
          console.warn('Could not resume session:', e);
          // Invalid saved user, show login
          APP.currentUser = null;
        }
      }
    }

    console.log('Starting Tyrone Agrochemicals OMS...');
    // Start the application
    checkLoginStatus();
  
  </script>
</body>
</html>
