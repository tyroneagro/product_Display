<!-- Updated Formulation Section -->

<script>
  // Formulation transaction log system (formulation_logs)
  const formulationLogs = [];

  // Real-time live search filters
  function filterFormulations(query) {
    // Implement filtering logic
  }

  // View state controller with safe listener cleanup
  const listeners = [];
  function addListener(event, callback) {
    // Safe listener addition
    const listener = { event, callback };
    listeners.push(listener);
    document.addEventListener(event, callback);
  }

  function cleanupListeners() {
    listeners.forEach(({ event, callback }) => {
      document.removeEventListener(event, callback);
    });
    listeners.length = 0;
  }

  // Quantity overflow prevention
  function validateQuantity(quantity) {
    if (quantity > maxQuantity) {
      throw new Error('Quantity exceeds maximum limit!');
    }
  }

  // Partial formulation support
  function isPartialFormulation(formulation) {
    return formulation.isPartial;
  }

  // Packing lock until formulation completed
  let isFormulationInProgress = false;
  function lockPacking() {
    if (isFormulationInProgress) {
      throw new Error('Packing is locked until formulation is completed.');
    }
  }

  // Auto order status update
  function updateOrderStatus(orderId, status) {
    // Implement status update logic
  }

  // Duplicate submission prevention
  const submissionTracker = new Set();
  function submitFormulation(formulation) {
    if (submissionTracker.has(formulation.id)) {
      throw new Error('Duplicate submission detected!');
    }
    submissionTracker.add(formulation.id);
    // Submit logic
  }

  // Multi-user safety
  const activeUsers = new Set();
  function registerUser(userId) {
    if (activeUsers.has(userId)) {
      throw new Error('User already registered!');
    }
    activeUsers.add(userId);
  }

  // Audit trail
  function logAction(action) {
    formulationLogs.push(action);
  }

  // Loading/Empty/Error states
  function showLoading() {
    // Code to show loading state
  }
  function showEmpty() {
    // Code to show empty state
  }
  function showError(message) {
    // Code to show error state
  }

  // Safe refresh handling
  window.addEventListener('beforeunload', cleanupListeners);
</script>

<!-- End of Updated Formulation Section -->